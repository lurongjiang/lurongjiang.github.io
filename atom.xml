<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Blog</title>
  
  <subtitle>个人博客,记录成长历程</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://lurongjiang.github.io/"/>
  <updated>2020-01-16T08:14:14.000Z</updated>
  <id>https://lurongjiang.github.io/</id>
  
  <author>
    <name>LRJ</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Gradle的安装和使用</title>
    <link href="https://lurongjiang.github.io/2020/01/15/Gradle%E7%9A%84%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/"/>
    <id>https://lurongjiang.github.io/2020/01/15/Gradle%E7%9A%84%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/</id>
    <published>2020-01-15T04:45:14.000Z</published>
    <updated>2020-01-16T08:14:14.000Z</updated>
    
    <content type="html"><![CDATA[        <h1   id="Gradle的安装和使用" >          <span class="heading-link">Gradle的安装和使用</span>        </h1>              <h2   id="下载" >          <span class="heading-link">下载</span>        </h2>      <p>可以去Gradle官网下载最新的稳定版本,目前是6.2,我自己下的4.8.1</p><p><span class="external-link"><a   href="https://downloads.gradle-dn.com/distributions/gradle-4.8.1-bin.zip"  target="_blank" rel="noopener">https://downloads.gradle-dn.com/distributions/gradle-4.8.1-bin.zip</a><i class="fa fa-external-link"></i></span></p>        <h2   id="安装" >          <span class="heading-link">安装</span>        </h2>      <p>Gradle的安装和Maven类似,就简单的解压,配置环境变量到Path就ok了</p><p><img src="/images/image/image-20200221102147192.png" alt="image-20200221102147192"></p><p><img src="/images/image/image-20200221102231848.png" alt="image-20200221102231848"></p><p>配置完成之后,打开cmd查看一下是否配置好了</p><p><img src="/images/image/image-20200221102351240.png" alt="image-20200221102351240"></p><p>看到正确输出了gradle的版本就说明配置好了</p>        <h2   id="IDEA配置Gradle" >          <span class="heading-link">IDEA配置Gradle</span>        </h2>      <p>Gradle和Maven这一点不同,Gradle无需再IDEA中进行配置操作,本地仓库地址的配置可以再IDEA中配置</p><p><img src="/images/image/image-20200221102917822.png" alt="image-20200221102917822"></p><p>这个我用的是环境变量来配置的,IDEA会自动识别,只需要在环境变量中新建一个GRADLE_USER_HOME变量指向自己的本地仓库地址就可以了</p><p><img src="/images/image/image-20200221103016741.png" alt="image-20200221103016741"></p>        <h2   id="Gradle初体验" >          <span class="heading-link">Gradle初体验</span>        </h2>              <h3   id="新建Gradle工程" >          <span class="heading-link">新建Gradle工程</span>        </h3>      <p>选择Gradle和JDK</p><p><img src="/images/image/image-20200221103418062.png" alt="image-20200221103418062"></p>        <h3   id="填写项目的GAV" >          <span class="heading-link">填写项目的GAV</span>        </h3>      <p>填写项目的GAV坐标,点Finished</p><p><img src="/images/image/image-20200221103642260.png" alt="image-20200221103642260"></p>        <h3   id="Gradle的目录" >          <span class="heading-link">Gradle的目录</span>        </h3>      <p>Gradle的目录结构和Maven类似</p><p><img src="/images/image/image-20200221104845138.png" alt="image-20200221104845138"></p><ul><li><p>src就是source目录</p><ul><li>src/main放代码目录<ul><li>src/main/java 放java代码目录</li><li>src/main/resouces放资源文件</li></ul></li></ul></li><li><p>src/test是测试目录</p><ul><li>src/test/java 放测试的java代码目录</li><li>src/test/resouces放测试的资源文件</li></ul></li></ul>        <h2   id="Groovy编程" >          <span class="heading-link">Groovy编程</span>        </h2>              <h3   id="打开Groovy-Console" >          <span class="heading-link">打开Groovy Console</span>        </h3>      <p>Tools-&gt;Groovy Console</p><p><img src="/images/image/image-20200221105555961.png" alt="image-20200221105555961"></p>        <h3   id="HelloWorld" >          <span class="heading-link">HelloWorld</span>        </h3>      <p>凡事先HelloWorld一下</p><p><img src="/images/image/image-20200221105836306.png" alt="image-20200221105836306"></p><p><img src="/images/image/image-20200221105915909.png" alt="image-20200221105915909"></p>        <h3   id="Groovy语法" >          <span class="heading-link">Groovy语法</span>        </h3>      <ul><li><p>Groovy可以省略最末尾的分号</p></li><li><p>Groovy可以省略小括号</p><p><img src="/images/image/image-20200221110227268.png" alt="image-20200221110227268"></p></li></ul><blockquote><p>这两个特性可以看出,Groovy的书写更加自由,随意</p></blockquote><ul><li><p>定义变量 def</p><p><img src="/images/image/image-20200221110338615.png" alt="image-20200221110338615"></p><p>groovy会根据数据自动推断类型</p></li><li><p>定义集合</p><p><img src="/images/image/image-20200221110630481.png" alt="image-20200221110630481"></p></li><li><p>定义Map</p><p><img src="/images/image/image-20200221110825151.png" alt="image-20200221110825151"></p></li><li><p>闭包</p><p>闭包就是一段代码块,在Gradle中主要是把闭包当参数使用</p><p><img src="/images/image/image-20200221111242382.png" alt="image-20200221111242382"></p></li><li><p>带参数的闭包</p><p><img src="/images/image/image-20200221111511073.png" alt="image-20200221111511073"></p></li></ul>        <h2   id="Gradle配置文件" >          <span class="heading-link">Gradle配置文件</span>        </h2>      <ul><li><p>build.gradle 构建项目配置</p><p><img src="/images/image/image-20200221112432889.png" alt="image-20200221112432889"></p></li></ul>        <h2   id="优先本地加载" >          <span class="heading-link">优先本地加载</span>        </h2>      <p>在repositories中指定先从本地加载</p><p><img src="/images/image/image-20200221113447193.png" alt="image-20200221113447193"></p>]]></content>
    
    <summary type="html">
    
      和Maven类似的项目依赖管理和构建工具Gradle的简单教程
    
    </summary>
    
    
      <category term="Gradle" scheme="https://lurongjiang.github.io/categories/Gradle/"/>
    
    
      <category term="Gradle" scheme="https://lurongjiang.github.io/tags/Gradle/"/>
    
  </entry>
  
  <entry>
    <title>Spring解析xml成BeanDefinition的过程</title>
    <link href="https://lurongjiang.github.io/2019/05/05/Spring%20Bean%E7%9A%84%E8%A7%A3%E6%9E%90%E8%BF%87%E7%A8%8B/"/>
    <id>https://lurongjiang.github.io/2019/05/05/Spring%20Bean%E7%9A%84%E8%A7%A3%E6%9E%90%E8%BF%87%E7%A8%8B/</id>
    <published>2019-05-05T02:24:42.000Z</published>
    <updated>2019-05-19T08:32:14.000Z</updated>
    
    <content type="html"><![CDATA[        <h1   id="Spring-Bean的解析过程" >          <span class="heading-link">Spring Bean的解析过程</span>        </h1>              <h2   id="xml文件的读取" >          <span class="heading-link">xml文件的读取</span>        </h2>      <p>从我们的入口开始</p><figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testXml</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ClassPathXmlApplicationContext context = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"spring.xml"</span>);</span><br><span class="line">    Student student = context.getBean(Student<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    System.out.println(student.getUsername());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure><p>先进入ClassPathXmlApplicationContext的构造器</p><figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ClassPathXmlApplicationContext</span><span class="params">(String configLocation)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">   <span class="keyword">this</span>(<span class="keyword">new</span> String[] &#123;configLocation&#125;, <span class="keyword">true</span>, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure><p>继续调用另一个构造器</p><figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ClassPathXmlApplicationContext</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      String[] configLocations, <span class="keyword">boolean</span> refresh, @Nullable ApplicationContext parent)</span></span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">   <span class="keyword">super</span>(parent);</span><br><span class="line">   <span class="comment">//创建解析器，解析configLocations</span></span><br><span class="line">   setConfigLocations(configLocations);</span><br><span class="line">   <span class="keyword">if</span> (refresh) &#123;</span><br><span class="line">      refresh();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure><p>这个refresh()方法是核心方法,点进去</p><figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException </span>&#123;</span><br><span class="line">   <span class="keyword">synchronized</span> (<span class="keyword">this</span>.startupShutdownMonitor) &#123;</span><br><span class="line">      <span class="comment">//为容器初始化做准备，重要程度：0</span></span><br><span class="line">      <span class="comment">// Prepare this context for refreshing.</span></span><br><span class="line">      prepareRefresh();</span><br><span class="line"></span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">         重要程度：5</span></span><br><span class="line"><span class="comment">        1、创建BeanFactory对象</span></span><br><span class="line"><span class="comment">      * 2、xml解析</span></span><br><span class="line"><span class="comment">      *  传统标签解析：bean、import等</span></span><br><span class="line"><span class="comment">      *  自定义标签解析 如：&lt;context:component-scan base-package="com.xiangxue.jack"/&gt;</span></span><br><span class="line"><span class="comment">      *  自定义标签解析流程：</span></span><br><span class="line"><span class="comment">      *     a、根据当前解析标签的头信息找到对应的namespaceUri</span></span><br><span class="line"><span class="comment">      *     b、加载spring所以jar中的spring.handlers文件。并建立映射关系</span></span><br><span class="line"><span class="comment">      *     c、根据namespaceUri从映射关系中找到对应的实现了NamespaceHandler接口的类</span></span><br><span class="line"><span class="comment">      *     d、调用类的init方法，init方法是注册了各种自定义标签的解析类</span></span><br><span class="line"><span class="comment">      *     e、根据namespaceUri找到对应的解析类，然后调用paser方法完成标签解析</span></span><br><span class="line"><span class="comment">      *</span></span><br><span class="line"><span class="comment">      * 3、把解析出来的xml标签封装成BeanDefinition对象</span></span><br><span class="line"><span class="comment">      * */</span></span><br><span class="line">      <span class="comment">// Tell the subclass to refresh the internal bean factory.</span></span><br><span class="line">      ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();</span><br><span class="line"></span><br><span class="line">       ....</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure><p>继续看obtainFreshBeanFactory()方法</p><figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> ConfigurableListableBeanFactory <span class="title">obtainFreshBeanFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 核心方法，必须读，重要程度：5</span></span><br><span class="line"><span class="comment">    * 这里使用了模板设计模式,Spring使用最多的设计模式,父类定义了模板,子类具体实现</span></span><br><span class="line"><span class="comment">    * 其实反过来看,AbstractApplicationContext的refresh()同样也是定义了模板,onFresh()方法交给子类去实现</span></span><br><span class="line"><span class="comment">    * 例如SpringBoot中嵌入式Tomcat启动就是覆写了onFresh()方法</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@see</span> AbstractApplicationContext#onRefresh()</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">   refreshBeanFactory();</span><br><span class="line">   <span class="keyword">return</span> getBeanFactory();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 因为ClassPathXmlApplicationContext是AbstractRefreshableApplicationContext的子类</span></span><br><span class="line"><span class="comment"> * 所以跳转到AbstractRefreshableApplicationContext</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> AbstractRefreshableApplicationContext#refreshBeanFactory()</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> BeansException        if initialization of the bean factory failed</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IllegalStateException if already initialized and multiple refresh</span></span><br><span class="line"><span class="comment"> *                               attempts are not supported</span></span><br><span class="line"><span class="comment"> *                               &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">refreshBeanFactory</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException</span>;</span><br></pre></td></tr></table></div></figure><p>跳转到AbstractRefreshableApplicationContext的refreshBeanFactory()</p><figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">refreshBeanFactory</span><span class="params">()</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//如果BeanFactory不为空，则清除BeanFactory和里面的实例</span></span><br><span class="line">   <span class="keyword">if</span> (hasBeanFactory()) &#123;</span><br><span class="line">      destroyBeans();</span><br><span class="line">      closeBeanFactory();</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">//创建DefaultListableBeanFactory</span></span><br><span class="line">      <span class="comment">//BeanFactory实例工厂,不管什么实例都可以从BeanFactory获取到</span></span><br><span class="line">      DefaultListableBeanFactory beanFactory = createBeanFactory();</span><br><span class="line">      beanFactory.setSerializationId(getId());</span><br><span class="line"></span><br><span class="line">      <span class="comment">//设置是否可以循环依赖 allowCircularReferences</span></span><br><span class="line">      <span class="comment">//是否允许使用相同名称重新注册不同的bean实现.</span></span><br><span class="line">      customizeBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * 解析xml，并把xml中的标签封装成BeanDefinition对象</span></span><br><span class="line"><span class="comment">       * 因为ClassPathXmlApplication是继承自 AbstractXmlApplicationContext</span></span><br><span class="line"><span class="comment">       * 所以进入AbstractXmlApplicationContext,又是一个模板</span></span><br><span class="line"><span class="comment">       * <span class="doctag">@see</span> AbstractXmlApplicationContext#loadBeanDefinitions(org.springframework.beans.factory.support.DefaultListableBeanFactory)</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      loadBeanDefinitions(beanFactory);</span><br><span class="line">      <span class="keyword">synchronized</span> (<span class="keyword">this</span>.beanFactoryMonitor) &#123;</span><br><span class="line">         <span class="keyword">this</span>.beanFactory = beanFactory;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ApplicationContextException(<span class="string">"I/O error parsing bean definition source for "</span> + getDisplayName(), ex);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">loadBeanDefinitions</span><span class="params">(DefaultListableBeanFactory beanFactory)</span></span></span><br><span class="line"><span class="function"><span class="keyword">throws</span> BeansException, IOException</span>;</span><br></pre></td></tr></table></div></figure><p>继续看AbstractXmlApplicationContext的loadBeanDefinitions(…)</p><p>xml的解析交给了XmlBeanDefinitionReader来解析</p><figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">loadBeanDefinitions</span><span class="params">(DefaultListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException, IOException </span>&#123;</span><br><span class="line">   <span class="comment">// Create a new XmlBeanDefinitionReader for the given BeanFactory.</span></span><br><span class="line">   <span class="comment">//创建xml的解析器，这里是一个委托模式</span></span><br><span class="line">   <span class="comment">//xml的解析工作,委托给XmlBeanDefinitionReader来解析</span></span><br><span class="line">   XmlBeanDefinitionReader beanDefinitionReader = <span class="keyword">new</span> XmlBeanDefinitionReader(beanFactory);</span><br><span class="line"></span><br><span class="line">....</span><br><span class="line">    </span><br><span class="line">   <span class="comment">//主要看这个方法  重要程度 5</span></span><br><span class="line">   loadBeanDefinitions(beanDefinitionReader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure><p>继续看loadBeanDefinitions(…)</p><figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">loadBeanDefinitions</span><span class="params">(XmlBeanDefinitionReader reader)</span> <span class="keyword">throws</span> BeansException, IOException </span>&#123;</span><br><span class="line">   Resource[] configResources = getConfigResources();</span><br><span class="line">   <span class="keyword">if</span> (configResources != <span class="keyword">null</span>) &#123;</span><br><span class="line">      reader.loadBeanDefinitions(configResources);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//获取需要加载的xml配置文件</span></span><br><span class="line">   String[] configLocations = getConfigLocations();</span><br><span class="line">   <span class="keyword">if</span> (configLocations != <span class="keyword">null</span>) &#123;</span><br><span class="line">       <span class="comment">//委托给reader来解析xml</span></span><br><span class="line">      reader.loadBeanDefinitions(configLocations);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure><p>点进去</p><figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">loadBeanDefinitions</span><span class="params">(String location)</span> <span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> loadBeanDefinitions(location, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">loadBeanDefinitions</span><span class="params">(String location, @Nullable Set&lt;Resource&gt; actualResources)</span> <span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</span><br><span class="line">    ResourceLoader resourceLoader = getResourceLoader();</span><br><span class="line">    <span class="keyword">if</span> (resourceLoader == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(</span><br><span class="line">            <span class="string">"Cannot load bean definitions from location ["</span> + location + <span class="string">"]: no ResourceLoader available"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (resourceLoader <span class="keyword">instanceof</span> ResourcePatternResolver) &#123;</span><br><span class="line">        <span class="comment">// Resource pattern matching available.</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//把字符串类型的xml文件路径，形如：classpath*:user/**/*-context.xml,转换成Resource对象类型，其实就是用流</span></span><br><span class="line">            <span class="comment">//的方式加载配置文件，然后封装成Resource对象，不重要，可以不看</span></span><br><span class="line">            Resource[] resources = ((ResourcePatternResolver) resourceLoader).getResources(location);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//主要看这个方法 ** 重要程度 5</span></span><br><span class="line">            <span class="keyword">int</span> count = loadBeanDefinitions(resources);</span><br><span class="line">           ....</span><br><span class="line">            <span class="keyword">return</span> count;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(</span><br><span class="line">                <span class="string">"Could not resolve bean definition resource pattern ["</span> + location + <span class="string">"]"</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Can only load single resources by absolute URL.</span></span><br><span class="line">        Resource resource = resourceLoader.getResource(location);</span><br><span class="line">        <span class="keyword">int</span> count = loadBeanDefinitions(resource);</span><br><span class="line">....</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure><p>把xml读出来之后封装成了Resource对象,开始解析Resource</p><figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">loadBeanDefinitions</span><span class="params">(Resource... resources)</span> <span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</span><br><span class="line">   Assert.notNull(resources, <span class="string">"Resource array must not be null"</span>);</span><br><span class="line">   <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">   <span class="keyword">for</span> (Resource resource : resources) &#123;</span><br><span class="line">      <span class="comment">//模板设计模式，调用到子类中的方法</span></span><br><span class="line">      <span class="comment">//又是一个模板,因为委托给了XmlBeanDefinitionReader</span></span><br><span class="line">      <span class="comment">/**<span class="doctag">@see</span> org.springframework.beans.factory.xml.XmlBeanDefinitionReader#loadBeanDefinitions(org.springframework.core.io.Resource)*/</span></span><br><span class="line">      count += loadBeanDefinitions(resource);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure><p>xml读出来之后,又把Resource封装成带编码的对象,委托给XmlBeanDefinitionReader进行解析</p><figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">loadBeanDefinitions</span><span class="params">(Resource resource)</span> <span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</span><br><span class="line">   <span class="comment">//EncodedResource带编码的对Resource对象的封装</span></span><br><span class="line">   <span class="comment">//把资源流对象又做了编码的封装</span></span><br><span class="line">   <span class="keyword">return</span> loadBeanDefinitions(<span class="keyword">new</span> EncodedResource(resource));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure><p>再看如何解析Resource的</p><figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">loadBeanDefinitions</span><span class="params">(EncodedResource encodedResource)</span> <span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">      </span><br><span class="line">   Set&lt;EncodedResource&gt; currentResources = <span class="keyword">this</span>.resourcesCurrentlyBeingLoaded.get();</span><br><span class="line">   <span class="keyword">if</span> (currentResources == <span class="keyword">null</span>) &#123;</span><br><span class="line">      currentResources = <span class="keyword">new</span> HashSet&lt;&gt;(<span class="number">4</span>);</span><br><span class="line">      <span class="keyword">this</span>.resourcesCurrentlyBeingLoaded.set(currentResources);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (!currentResources.add(encodedResource)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(</span><br><span class="line">            <span class="string">"Detected cyclic loading of "</span> + encodedResource + <span class="string">" - check your import definitions!"</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">//获取Resource对象中的xml文件流对象</span></span><br><span class="line">      InputStream inputStream = encodedResource.getResource().getInputStream();</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="comment">//InputSource是jdk中的sax xml文件解析对象</span></span><br><span class="line">         InputSource inputSource = <span class="keyword">new</span> InputSource(inputStream);</span><br><span class="line">         <span class="keyword">if</span> (encodedResource.getEncoding() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            inputSource.setEncoding(encodedResource.getEncoding());</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="comment">//主要看这个方法 **  重要程度 5</span></span><br><span class="line">         <span class="keyword">return</span> doLoadBeanDefinitions(inputSource, encodedResource.getResource());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">finally</span> &#123;</span><br><span class="line">         inputStream.close();</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">    ...</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">finally</span> &#123;</span><br><span class="line">      currentResources.remove(encodedResource);</span><br><span class="line">      <span class="keyword">if</span> (currentResources.isEmpty()) &#123;</span><br><span class="line">         <span class="keyword">this</span>.resourcesCurrentlyBeingLoaded.remove();</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure><p>把InputStream流对象从Resouce中读出来,封装成InputSource对象</p><figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">doLoadBeanDefinitions</span><span class="params">(InputSource inputSource, Resource resource)</span></span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">//把inputSource 封装成Document文件对象，这是jdk的API</span></span><br><span class="line">      Document doc = doLoadDocument(inputSource, resource);</span><br><span class="line"></span><br><span class="line">      <span class="comment">//主要看这个方法，根据解析出来的document对象，拿到里面的标签元素封装成BeanDefinition</span></span><br><span class="line">      <span class="keyword">int</span> count = registerBeanDefinitions(doc, resource);</span><br><span class="line">      <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">         logger.debug(<span class="string">"Loaded "</span> + count + <span class="string">" bean definitions from "</span> + resource);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> count;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (BeanDefinitionStoreException ex) &#123;</span><br><span class="line"> ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure><p>把流对象InputSource使用SAX进行解析成Document对象,对Document对象进行解析</p><figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">registerBeanDefinitions</span><span class="params">(Document doc, Resource resource)</span> <span class="keyword">throws</span> BeanDefinitionStoreException </span>&#123;</span><br><span class="line">    <span class="comment">//xml解析成Document之后,又将Document委托给BeanDefinitionDocumentReader来解析Document成BeanDefinition</span></span><br><span class="line">    <span class="comment">//又来一记委托模式，BeanDefinitionDocumentReader委托这个类进行document的解析</span></span><br><span class="line">    BeanDefinitionDocumentReader documentReader = createBeanDefinitionDocumentReader();</span><br><span class="line">    <span class="keyword">int</span> countBefore = getRegistry().getBeanDefinitionCount();</span><br><span class="line">    <span class="comment">//主要看这个方法，createReaderContext(resource) XmlReaderContext上下文，封装了XmlBeanDefinitionReader对象</span></span><br><span class="line">    documentReader.registerBeanDefinitions(doc, createReaderContext(resource));</span><br><span class="line">    <span class="keyword">return</span> getRegistry().getBeanDefinitionCount() - countBefore;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure><p>Document委托给BeanDefinitionDocumentReader来解析Document成BeanDefinition</p><figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(Document doc, XmlReaderContext readerContext)</span></span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> BeanDefinitionStoreException</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(Document doc, XmlReaderContext readerContext)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.readerContext = readerContext;</span><br><span class="line">    <span class="comment">//主要看这个方法，把root节点传进去</span></span><br><span class="line">    doRegisterBeanDefinitions(doc.getDocumentElement());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doRegisterBeanDefinitions</span><span class="params">(Element root)</span> </span>&#123;</span><br><span class="line">    BeanDefinitionParserDelegate parent = <span class="keyword">this</span>.delegate;</span><br><span class="line">    <span class="keyword">this</span>.delegate = createDelegate(getReaderContext(), root, parent);</span><br><span class="line">...</span><br><span class="line">    <span class="comment">//又是模板,冗余设计,空实现</span></span><br><span class="line">    preProcessXml(root);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//主要看这个方法，标签具体解析过程</span></span><br><span class="line">    parseBeanDefinitions(root, <span class="keyword">this</span>.delegate);</span><br><span class="line">    postProcessXml(root);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.delegate = parent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure><p>把Document的根传进去,开始解析Document</p><figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">parseBeanDefinitions</span><span class="params">(Element root, BeanDefinitionParserDelegate delegate)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (delegate.isDefaultNamespace(root)) &#123;</span><br><span class="line">      <span class="comment">//获取根节点下的所有子节点</span></span><br><span class="line">      <span class="comment">//遍历所有子节点,依次解析</span></span><br><span class="line">      NodeList nl = root.getChildNodes();</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nl.getLength(); i++) &#123;</span><br><span class="line">         Node node = nl.item(i);</span><br><span class="line">         <span class="keyword">if</span> (node <span class="keyword">instanceof</span> Element) &#123;</span><br><span class="line">            Element ele = (Element) node;</span><br><span class="line">            <span class="keyword">if</span> (delegate.isDefaultNamespace(ele)) &#123;</span><br><span class="line">               <span class="comment">//默认标签解析,import,alias,bean,beans</span></span><br><span class="line">               parseDefaultElement(ele, delegate);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="comment">//自定义标签解析,委托给BeanDefinitionParserDelegate来解析</span></span><br><span class="line">               <span class="comment">//context:component-scan等,使用了namespaceUri</span></span><br><span class="line">               delegate.parseCustomElement(ele);</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line">      delegate.parseCustomElement(root);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure><p>标签的解析分为默认标签(包括import,alias,bean,beans)和自定义标签(如context:componet-scan,mvc:annotation-drive等,这类带前缀的标签需要namespaceUri来指定实现,使用了SPI思想)</p>        <h2   id="默认标签的解析" >          <span class="heading-link">默认标签的解析</span>        </h2>      <p>先看默认标签的解析</p><figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseDefaultElement</span><span class="params">(Element ele, BeanDefinitionParserDelegate delegate)</span> </span>&#123;</span><br><span class="line">   <span class="comment">//import标签解析  重要程度 1 ，可看可不看</span></span><br><span class="line">   <span class="keyword">if</span> (delegate.nodeNameEquals(ele, IMPORT_ELEMENT)) &#123;</span><br><span class="line">      importBeanDefinitionResource(ele);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//alias标签解析 别名标签  重要程度 1 ，可看可不看</span></span><br><span class="line">   <span class="keyword">else</span> <span class="keyword">if</span> (delegate.nodeNameEquals(ele, ALIAS_ELEMENT)) &#123;</span><br><span class="line">      processAliasRegistration(ele);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//bean标签，重要程度  5，必须看</span></span><br><span class="line">   <span class="keyword">else</span> <span class="keyword">if</span> (delegate.nodeNameEquals(ele, BEAN_ELEMENT)) &#123;</span><br><span class="line">      processBeanDefinition(ele, delegate);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> <span class="keyword">if</span> (delegate.nodeNameEquals(ele, NESTED_BEANS_ELEMENT)) &#123;</span><br><span class="line">      <span class="comment">// recurse</span></span><br><span class="line">      doRegisterBeanDefinitions(ele);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure><p>核心方法processBeanDefinition(…)</p><figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">processBeanDefinition</span><span class="params">(Element ele, BeanDefinitionParserDelegate delegate)</span> </span>&#123;</span><br><span class="line">   <span class="comment">//重点看这个方法，重要程度 5 ，解析document，封装成BeanDefinition</span></span><br><span class="line">   BeanDefinitionHolder bdHolder = delegate.parseBeanDefinitionElement(ele);</span><br><span class="line">   <span class="keyword">if</span> (bdHolder != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//该方法功能不重要，设计模式重点看一下，装饰者设计模式，加上SPI设计思想</span></span><br><span class="line">      bdHolder = delegate.decorateBeanDefinitionIfRequired(ele, bdHolder);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">         <span class="comment">//完成document到BeanDefinition对象转换后，对BeanDefinition对象进行缓存注册</span></span><br><span class="line">         <span class="comment">// Register the final decorated instance.</span></span><br><span class="line">         BeanDefinitionReaderUtils.registerBeanDefinition(bdHolder, getReaderContext().getRegistry());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (BeanDefinitionStoreException ex) &#123;</span><br><span class="line">         getReaderContext().error(<span class="string">"Failed to register bean definition with name '"</span> +</span><br><span class="line">               bdHolder.getBeanName() + <span class="string">"'"</span>, ele, ex);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// Send registration event.</span></span><br><span class="line">      getReaderContext().fireComponentRegistered(<span class="keyword">new</span> BeanComponentDefinition(bdHolder));</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure><p>继续看BeanDefinitionParserDelegate是如何解析的parseBeanDefinitionElement(ele)</p><figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> BeanDefinitionHolder <span class="title">parseBeanDefinitionElement</span><span class="params">(Element ele)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> parseBeanDefinitionElement(ele, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure><figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> BeanDefinitionHolder <span class="title">parseBeanDefinitionElement</span><span class="params">(Element ele, @Nullable BeanDefinition containingBean)</span> </span>&#123;</span><br><span class="line">   String id = ele.getAttribute(ID_ATTRIBUTE);</span><br><span class="line">   String nameAttr = ele.getAttribute(NAME_ATTRIBUTE);</span><br><span class="line"></span><br><span class="line">   List&lt;String&gt; aliases = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">   <span class="keyword">if</span> (StringUtils.hasLength(nameAttr)) &#123;</span><br><span class="line">      String[] nameArr = StringUtils.tokenizeToStringArray(nameAttr, MULTI_VALUE_ATTRIBUTE_DELIMITERS);</span><br><span class="line">      aliases.addAll(Arrays.asList(nameArr));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   String beanName = id;</span><br><span class="line">   <span class="keyword">if</span> (!StringUtils.hasText(beanName) &amp;&amp; !aliases.isEmpty()) &#123;</span><br><span class="line">      beanName = aliases.remove(<span class="number">0</span>);</span><br><span class="line">     ...</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//检查beanName是否重复</span></span><br><span class="line">   <span class="keyword">if</span> (containingBean == <span class="keyword">null</span>) &#123;</span><br><span class="line">      checkNameUniqueness(beanName, aliases, ele);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//继续点进去看</span></span><br><span class="line">   AbstractBeanDefinition beanDefinition = parseBeanDefinitionElement(ele, beanName, containingBean);</span><br><span class="line">   <span class="keyword">if</span> (beanDefinition != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!StringUtils.hasText(beanName)) &#123;</span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (containingBean != <span class="keyword">null</span>) &#123;</span><br><span class="line">               beanName = BeanDefinitionReaderUtils.generateBeanName(</span><br><span class="line">                     beanDefinition, <span class="keyword">this</span>.readerContext.getRegistry(), <span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">               beanName = <span class="keyword">this</span>.readerContext.generateBeanName(beanDefinition);</span><br><span class="line">               <span class="comment">// Register an alias for the plain bean class name, if still possible,</span></span><br><span class="line">               <span class="comment">// if the generator returned the class name plus a suffix.</span></span><br><span class="line">               <span class="comment">// This is expected for Spring 1.2/2.0 backwards compatibility.</span></span><br><span class="line">               String beanClassName = beanDefinition.getBeanClassName();</span><br><span class="line">               <span class="keyword">if</span> (beanClassName != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                     beanName.startsWith(beanClassName) &amp;&amp; beanName.length() &gt; beanClassName.length() &amp;&amp;</span><br><span class="line">                     !<span class="keyword">this</span>.readerContext.getRegistry().isBeanNameInUse(beanClassName)) &#123;</span><br><span class="line">                  aliases.add(beanClassName);</span><br><span class="line">               &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">               logger.trace(<span class="string">"Neither XML 'id' nor 'name' specified - "</span> +</span><br><span class="line">                     <span class="string">"using generated bean name ["</span> + beanName + <span class="string">"]"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            error(ex.getMessage(), ele);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      String[] aliasesArray = StringUtils.toStringArray(aliases);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> BeanDefinitionHolder(beanDefinition, beanName, aliasesArray);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure><p>继续点</p><figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> AbstractBeanDefinition <span class="title">parseBeanDefinitionElement</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">      Element ele, String beanName, @Nullable BeanDefinition containingBean)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">this</span>.parseState.push(<span class="keyword">new</span> BeanEntry(beanName));</span><br><span class="line"></span><br><span class="line">   String className = <span class="keyword">null</span>;</span><br><span class="line">   <span class="keyword">if</span> (ele.hasAttribute(CLASS_ATTRIBUTE)) &#123;</span><br><span class="line">      className = ele.getAttribute(CLASS_ATTRIBUTE).trim();</span><br><span class="line">   &#125;</span><br><span class="line">   String parent = <span class="keyword">null</span>;</span><br><span class="line">   <span class="keyword">if</span> (ele.hasAttribute(PARENT_ATTRIBUTE)) &#123;</span><br><span class="line">      parent = ele.getAttribute(PARENT_ATTRIBUTE);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">//创建GenericBeanDefinition对象,设置parent和className</span></span><br><span class="line">      AbstractBeanDefinition bd = createBeanDefinition(className, parent);</span><br><span class="line"></span><br><span class="line">      <span class="comment">//解析bean标签的属性，并把解析出来的属性设置到BeanDefinition对象中</span></span><br><span class="line">      parseBeanDefinitionAttributes(ele, beanName, containingBean, bd);</span><br><span class="line">      bd.setDescription(DomUtils.getChildElementValueByTagName(ele, DESCRIPTION_ELEMENT));</span><br><span class="line"></span><br><span class="line">      <span class="comment">//解析bean中的meta标签</span></span><br><span class="line">      parseMetaElements(ele, bd);</span><br><span class="line"></span><br><span class="line">      <span class="comment">//解析bean中的lookup-method标签  重要程度：2，可看可不看</span></span><br><span class="line">      parseLookupOverrideSubElements(ele, bd.getMethodOverrides());</span><br><span class="line"></span><br><span class="line">      <span class="comment">//解析bean中的replaced-method标签  重要程度：2，可看可不看</span></span><br><span class="line">      parseReplacedMethodSubElements(ele, bd.getMethodOverrides());</span><br><span class="line"></span><br><span class="line">      <span class="comment">//解析bean中的constructor-arg标签  重要程度：2，可看可不看</span></span><br><span class="line">      parseConstructorArgElements(ele, bd);</span><br><span class="line"></span><br><span class="line">      <span class="comment">//解析bean中的property标签  重要程度：2，可看可不看</span></span><br><span class="line">      parsePropertyElements(ele, bd);</span><br><span class="line"></span><br><span class="line">      <span class="comment">//可以不看，用不到</span></span><br><span class="line">      parseQualifierElements(ele, bd);</span><br><span class="line"></span><br><span class="line">      bd.setResource(<span class="keyword">this</span>.readerContext.getResource());</span><br><span class="line">      bd.setSource(extractSource(ele));</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> bd;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</span><br><span class="line">   ...</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.parseState.pop();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure><p>先创建BeanDefinition的封装GenericBeanDefinition</p>        <h3   id="属性解析" >          <span class="heading-link">属性解析</span>        </h3>      <p>解析每个节点的属性</p><figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> AbstractBeanDefinition <span class="title">parseBeanDefinitionAttributes</span><span class="params">(Element ele, String beanName,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                            @Nullable BeanDefinition containingBean, AbstractBeanDefinition bd)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//如果有singleton属性,先提示一下,建议使用scope属性</span></span><br><span class="line">    <span class="keyword">if</span> (ele.hasAttribute(SINGLETON_ATTRIBUTE)) &#123;</span><br><span class="line">        error(<span class="string">"Old 1.x 'singleton' attribute in use - upgrade to 'scope' declaration"</span>, ele);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (ele.hasAttribute(SCOPE_ATTRIBUTE)) &#123;</span><br><span class="line">        <span class="comment">//如果有scope属性,设置scope</span></span><br><span class="line">        bd.setScope(ele.getAttribute(SCOPE_ATTRIBUTE));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (containingBean != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Take default from containing bean in case of an inner bean definition.</span></span><br><span class="line">        bd.setScope(containingBean.getScope());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置abstract属性,不实例化,子类需要parent标签引用,父类提供了公共的属性,子类不需要写那么多了</span></span><br><span class="line">    <span class="keyword">if</span> (ele.hasAttribute(ABSTRACT_ATTRIBUTE)) &#123;</span><br><span class="line">        bd.setAbstract(TRUE_VALUE.equals(ele.getAttribute(ABSTRACT_ATTRIBUTE)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置lazy-init属性</span></span><br><span class="line">    String lazyInit = ele.getAttribute(LAZY_INIT_ATTRIBUTE);</span><br><span class="line">    <span class="keyword">if</span> (DEFAULT_VALUE.equals(lazyInit)) &#123;</span><br><span class="line">        lazyInit = <span class="keyword">this</span>.defaults.getLazyInit();</span><br><span class="line">    &#125;</span><br><span class="line">    bd.setLazyInit(TRUE_VALUE.equals(lazyInit));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置autowired属性</span></span><br><span class="line">    String autowire = ele.getAttribute(AUTOWIRE_ATTRIBUTE);</span><br><span class="line">    bd.setAutowireMode(getAutowireMode(autowire));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置depends-on属性</span></span><br><span class="line">    <span class="keyword">if</span> (ele.hasAttribute(DEPENDS_ON_ATTRIBUTE)) &#123;</span><br><span class="line">        String dependsOn = ele.getAttribute(DEPENDS_ON_ATTRIBUTE);</span><br><span class="line">        bd.setDependsOn(StringUtils.tokenizeToStringArray(dependsOn, MULTI_VALUE_ATTRIBUTE_DELIMITERS));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置autowired-candidate</span></span><br><span class="line">    String autowireCandidate = ele.getAttribute(AUTOWIRE_CANDIDATE_ATTRIBUTE);</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">""</span>.equals(autowireCandidate) || DEFAULT_VALUE.equals(autowireCandidate)) &#123;</span><br><span class="line">        String candidatePattern = <span class="keyword">this</span>.defaults.getAutowireCandidates();</span><br><span class="line">        <span class="keyword">if</span> (candidatePattern != <span class="keyword">null</span>) &#123;</span><br><span class="line">            String[] patterns = StringUtils.commaDelimitedListToStringArray(candidatePattern);</span><br><span class="line">            bd.setAutowireCandidate(PatternMatchUtils.simpleMatch(patterns, beanName));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        bd.setAutowireCandidate(TRUE_VALUE.equals(autowireCandidate));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置primary</span></span><br><span class="line">    <span class="keyword">if</span> (ele.hasAttribute(PRIMARY_ATTRIBUTE)) &#123;</span><br><span class="line">        bd.setPrimary(TRUE_VALUE.equals(ele.getAttribute(PRIMARY_ATTRIBUTE)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置init-method</span></span><br><span class="line">    <span class="keyword">if</span> (ele.hasAttribute(INIT_METHOD_ATTRIBUTE)) &#123;</span><br><span class="line">        String initMethodName = ele.getAttribute(INIT_METHOD_ATTRIBUTE);</span><br><span class="line">        bd.setInitMethodName(initMethodName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.defaults.getInitMethod() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        bd.setInitMethodName(<span class="keyword">this</span>.defaults.getInitMethod());</span><br><span class="line">        bd.setEnforceInitMethod(<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置destroy-method</span></span><br><span class="line">    <span class="keyword">if</span> (ele.hasAttribute(DESTROY_METHOD_ATTRIBUTE)) &#123;</span><br><span class="line">        String destroyMethodName = ele.getAttribute(DESTROY_METHOD_ATTRIBUTE);</span><br><span class="line">        bd.setDestroyMethodName(destroyMethodName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.defaults.getDestroyMethod() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        bd.setDestroyMethodName(<span class="keyword">this</span>.defaults.getDestroyMethod());</span><br><span class="line">        bd.setEnforceDestroyMethod(<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置factory-method,指定生成实例的工厂方法</span></span><br><span class="line">    <span class="keyword">if</span> (ele.hasAttribute(FACTORY_METHOD_ATTRIBUTE)) &#123;</span><br><span class="line">        bd.setFactoryMethodName(ele.getAttribute(FACTORY_METHOD_ATTRIBUTE));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//设置factory-bean属性,指定生成实例的工厂,这个需要配合factory-method使用</span></span><br><span class="line">    <span class="keyword">if</span> (ele.hasAttribute(FACTORY_BEAN_ATTRIBUTE)) &#123;</span><br><span class="line">        bd.setFactoryBeanName(ele.getAttribute(FACTORY_BEAN_ATTRIBUTE));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure><p>parseBeanDefinitionAttributes(..)方法主要是解析Node的属性并设置了BeanDefinition的一些属性</p>        <h3   id="meta标签解析" >          <span class="heading-link">meta标签解析</span>        </h3>      <p>再看meta标签的解析,其实就是把bean标签的meta属性的key,value读取出来,设置到BeanDefinition,没啥用,一个标识而已</p><figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parseMetaElements</span><span class="params">(Element ele, BeanMetadataAttributeAccessor attributeAccessor)</span> </span>&#123;</span><br><span class="line">   NodeList nl = ele.getChildNodes();</span><br><span class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nl.getLength(); i++) &#123;</span><br><span class="line">      Node node = nl.item(i);</span><br><span class="line">      <span class="keyword">if</span> (isCandidateElement(node) &amp;&amp; nodeNameEquals(node, META_ELEMENT)) &#123;</span><br><span class="line">         Element metaElement = (Element) node;</span><br><span class="line">         String key = metaElement.getAttribute(KEY_ATTRIBUTE);</span><br><span class="line">         String value = metaElement.getAttribute(VALUE_ATTRIBUTE);</span><br><span class="line">         BeanMetadataAttribute attribute = <span class="keyword">new</span> BeanMetadataAttribute(key, value);</span><br><span class="line">         attribute.setSource(extractSource(metaElement));</span><br><span class="line">         attributeAccessor.addMetadataAttribute(attribute);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>        <h3   id="lookup-method标签解析" >          <span class="heading-link">lookup-method标签解析</span>        </h3>      <p>同样的lookup-method标签的解析也是类似的</p><figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parseLookupOverrideSubElements</span><span class="params">(Element beanEle, MethodOverrides overrides)</span> </span>&#123;</span><br><span class="line">    NodeList nl = beanEle.getChildNodes();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nl.getLength(); i++) &#123;</span><br><span class="line">        Node node = nl.item(i);</span><br><span class="line">        <span class="keyword">if</span> (isCandidateElement(node) &amp;&amp; nodeNameEquals(node, LOOKUP_METHOD_ELEMENT)) &#123;</span><br><span class="line">            Element ele = (Element) node;</span><br><span class="line">            <span class="comment">//获取name属性</span></span><br><span class="line">            String methodName = ele.getAttribute(NAME_ATTRIBUTE);</span><br><span class="line">            <span class="comment">//获取bean属性</span></span><br><span class="line">            String beanRef = ele.getAttribute(BEAN_ELEMENT);</span><br><span class="line">            <span class="comment">//封装成 LookupOverride</span></span><br><span class="line">            LookupOverride override = <span class="keyword">new</span> LookupOverride(methodName, beanRef);</span><br><span class="line">            override.setSource(extractSource(ele));</span><br><span class="line">            <span class="comment">//可能有多个lookup-method标签,所以用list装起来</span></span><br><span class="line">            overrides.addOverride(override);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure><hr><p>不过值得一提的是,这个lookup-method的设计精髓主要是代理思想,很方便的实现了多态</p><figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"com.lrj.test.bean.Student"</span> <span class="attr">id</span>=<span class="string">"student"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"com.lrj.test.bean.Women"</span> <span class="attr">id</span>=<span class="string">"women"</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--实现多态,传入什么就是什么--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"com.lrj.test.bean.AbstractClass"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">lookup-method</span> <span class="attr">name</span>=<span class="string">"getPeople"</span> <span class="attr">bean</span>=<span class="string">"women"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></div></figure><figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">People</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Women</span> <span class="keyword">extends</span> <span class="title">People</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"I am women"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractClass</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        getPeople().show();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> People <span class="title">getPeople</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//这个方法最终打印的是I am women</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testXml</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ClassPathXmlApplicationContext context = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"spring.xml"</span>);</span><br><span class="line">    AbstractClass abstractClass=context.getBean(AbstractClass<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    abstractClass.show();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure><hr>        <h3   id="replace-method标签解析" >          <span class="heading-link">replace-method标签解析</span>        </h3>      <p>再看看parseReplacedMethodSubElements(…)解析replace-method属性</p><figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parseReplacedMethodSubElements</span><span class="params">(Element beanEle, MethodOverrides overrides)</span> </span>&#123;</span><br><span class="line">   NodeList nl = beanEle.getChildNodes();</span><br><span class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nl.getLength(); i++) &#123;</span><br><span class="line">      Node node = nl.item(i);</span><br><span class="line">      <span class="keyword">if</span> (isCandidateElement(node) &amp;&amp; nodeNameEquals(node, REPLACED_METHOD_ELEMENT)) &#123;</span><br><span class="line">         Element replacedMethodEle = (Element) node;</span><br><span class="line">         String name = replacedMethodEle.getAttribute(NAME_ATTRIBUTE);</span><br><span class="line">         String callback = replacedMethodEle.getAttribute(REPLACER_ATTRIBUTE);</span><br><span class="line"></span><br><span class="line">         <span class="comment">//一个replaced-method标签封装成一个ReplaceOverride对象，最后加入到BeanDefinition对象中</span></span><br><span class="line">         ReplaceOverride replaceOverride = <span class="keyword">new</span> ReplaceOverride(name, callback);</span><br><span class="line">         <span class="comment">// Look for arg-type match elements.</span></span><br><span class="line">         List&lt;Element&gt; argTypeEles = DomUtils.getChildElementsByTagName(replacedMethodEle, ARG_TYPE_ELEMENT);</span><br><span class="line">         <span class="keyword">for</span> (Element argTypeEle : argTypeEles) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//根据方法参数类型来区分同名的不同的方法</span></span><br><span class="line">            String match = argTypeEle.getAttribute(ARG_TYPE_MATCH_ATTRIBUTE);</span><br><span class="line">            match = (StringUtils.hasText(match) ? match : DomUtils.getTextValue(argTypeEle));</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.hasText(match)) &#123;</span><br><span class="line">               replaceOverride.addTypeIdentifier(match);</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         replaceOverride.setSource(extractSource(replacedMethodEle));</span><br><span class="line">         overrides.addOverride(replaceOverride);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure><p>可以发现lookup-method和replace-method都放入了BeanDefinition的<strong>MethodOverrides</strong>类型的overrides属性中,也就是说,MethodOverrides包含了LookupOverride和ReplaceOverride两种类型的对象</p><hr><figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"com.lrj.test.bean.Replacement"</span> <span class="attr">id</span>=<span class="string">"replacement"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"com.lrj.test.bean.Origin"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">replaced-method</span> <span class="attr">name</span>=<span class="string">"show"</span> <span class="attr">replacer</span>=<span class="string">"replacement"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">arg-type</span> <span class="attr">match</span>=<span class="string">"int"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">replaced-method</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></div></figure><figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Origin</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"show str:"</span> + str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">(<span class="keyword">int</span> str)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"show int:"</span> + str);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Replacement</span> <span class="keyword">implements</span> <span class="title">MethodReplacer</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">reimplement</span><span class="params">(Object obj, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"I am a placement method......"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//这个打印的将会是show str:hello和I am a placement method......</span></span><br><span class="line"><span class="comment">//说明int的被替换了,但是String的没有被替换,</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testReplace</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ClassPathXmlApplicationContext context = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"spring.xml"</span>);</span><br><span class="line">    Origin origin = context.getBean(Origin<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    origin.show(<span class="string">"hello"</span>);</span><br><span class="line">    origin.show(<span class="number">555</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure><p>这个听说是在项目封版之后,不想改代码了,直接改配置,符合开闭原则,但是这个Replacement必须要实现MethodReplacer感觉有点鸡肋</p>        <h3   id="constructor-arg标签解析" >          <span class="heading-link">constructor-arg标签解析</span>        </h3>      <p>这个没啥讲的,无非是根据index或者name来设置</p><p>不过需要注意ConstructorArgumentValues对象保存了ValueHolder集合</p><p>解析construct-arg标签,读取下标或者name封装成<strong>ValueHolder</strong>,构成BeanDefinition的<strong>ConstructorArgumentValues</strong></p><figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parseConstructorArgElements</span><span class="params">(Element beanEle, BeanDefinition bd)</span> </span>&#123;</span><br><span class="line">   NodeList nl = beanEle.getChildNodes();</span><br><span class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nl.getLength(); i++) &#123;</span><br><span class="line">      Node node = nl.item(i);</span><br><span class="line">      <span class="keyword">if</span> (isCandidateElement(node) &amp;&amp; nodeNameEquals(node, CONSTRUCTOR_ARG_ELEMENT)) &#123;</span><br><span class="line">         parseConstructorArgElement((Element) node, bd);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parseConstructorArgElement</span><span class="params">(Element ele, BeanDefinition bd)</span> </span>&#123;</span><br><span class="line">    String indexAttr = ele.getAttribute(INDEX_ATTRIBUTE);</span><br><span class="line">    String typeAttr = ele.getAttribute(TYPE_ATTRIBUTE);</span><br><span class="line">    String nameAttr = ele.getAttribute(NAME_ATTRIBUTE);</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.hasLength(indexAttr)) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> index = Integer.parseInt(indexAttr);</span><br><span class="line">            <span class="keyword">if</span> (index &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                error(<span class="string">"'index' cannot be lower than 0"</span>, ele);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">this</span>.parseState.push(<span class="keyword">new</span> ConstructorArgumentEntry(index));</span><br><span class="line">                    Object value = parsePropertyValue(ele, bd, <span class="keyword">null</span>);</span><br><span class="line">                    ConstructorArgumentValues.ValueHolder valueHolder = <span class="keyword">new</span> ConstructorArgumentValues.ValueHolder(value);</span><br><span class="line">                    <span class="keyword">if</span> (StringUtils.hasLength(typeAttr)) &#123;</span><br><span class="line">                        valueHolder.setType(typeAttr);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (StringUtils.hasLength(nameAttr)) &#123;</span><br><span class="line">                        valueHolder.setName(nameAttr);</span><br><span class="line">                    &#125;</span><br><span class="line">                    valueHolder.setSource(extractSource(ele));</span><br><span class="line">                    <span class="keyword">if</span> (bd.getConstructorArgumentValues().hasIndexedArgumentValue(index)) &#123;</span><br><span class="line">                        error(<span class="string">"Ambiguous constructor-arg entries for index "</span> + index, ele);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">//将ValueHolder添加到BeanDefinition</span></span><br><span class="line">                        bd.getConstructorArgumentValues().addIndexedArgumentValue(index, valueHolder);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="keyword">this</span>.parseState.pop();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (NumberFormatException ex) &#123;</span><br><span class="line">            error(<span class="string">"Attribute 'index' of tag 'constructor-arg' must be an integer"</span>, ele);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.parseState.push(<span class="keyword">new</span> ConstructorArgumentEntry());</span><br><span class="line">            Object value = parsePropertyValue(ele, bd, <span class="keyword">null</span>);</span><br><span class="line">            ConstructorArgumentValues.ValueHolder valueHolder = <span class="keyword">new</span> ConstructorArgumentValues.ValueHolder(value);</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.hasLength(typeAttr)) &#123;</span><br><span class="line">                valueHolder.setType(typeAttr);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.hasLength(nameAttr)) &#123;</span><br><span class="line">                valueHolder.setName(nameAttr);</span><br><span class="line">            &#125;</span><br><span class="line">            valueHolder.setSource(extractSource(ele));</span><br><span class="line">            <span class="comment">//将ValueHolder添加到BeanDefinition</span></span><br><span class="line">            bd.getConstructorArgumentValues().addGenericArgumentValue(valueHolder);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.parseState.pop();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>        <h3   id="property标签解析" >          <span class="heading-link">property标签解析</span>        </h3>      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parsePropertyElements</span><span class="params">(Element beanEle, BeanDefinition bd)</span> </span>&#123;</span><br><span class="line">   NodeList nl = beanEle.getChildNodes();</span><br><span class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nl.getLength(); i++) &#123;</span><br><span class="line">      Node node = nl.item(i);</span><br><span class="line">      <span class="keyword">if</span> (isCandidateElement(node) &amp;&amp; nodeNameEquals(node, PROPERTY_ELEMENT)) &#123;</span><br><span class="line">         parsePropertyElement((Element) node, bd);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parsePropertyElement</span><span class="params">(Element ele, BeanDefinition bd)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//获取name属性</span></span><br><span class="line">    String propertyName = ele.getAttribute(NAME_ATTRIBUTE);</span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.hasLength(propertyName)) &#123;</span><br><span class="line">        error(<span class="string">"Tag 'property' must have a 'name' attribute"</span>, ele);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.parseState.push(<span class="keyword">new</span> PropertyEntry(propertyName));</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (bd.getPropertyValues().contains(propertyName)) &#123;</span><br><span class="line">            error(<span class="string">"Multiple 'property' definitions for property '"</span> + propertyName + <span class="string">"'"</span>, ele);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Object val = parsePropertyValue(ele, bd, propertyName);</span><br><span class="line">        <span class="comment">//将属性设置包装成 PropertyValue</span></span><br><span class="line">        PropertyValue pv = <span class="keyword">new</span> PropertyValue(propertyName, val);</span><br><span class="line">        parseMetaElements(ele, pv);</span><br><span class="line">        pv.setSource(extractSource(ele));</span><br><span class="line">        <span class="comment">//将 PropertyValue添加到BeanDefinition</span></span><br><span class="line">        bd.getPropertyValues().addPropertyValue(pv);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.parseState.pop();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure><p>和解析构造函数的参数一样,对于property标签的解析,同样是将key,value封装成<strong>PropertyValue</strong>,添加到BeanDefinition中,形成<strong>MutablePropertyValues</strong>类型</p>        <h3   id="qualifier标签解析" >          <span class="heading-link">qualifier标签解析</span>        </h3>      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parseQualifierElements</span><span class="params">(Element beanEle, AbstractBeanDefinition bd)</span> </span>&#123;</span><br><span class="line">   NodeList nl = beanEle.getChildNodes();</span><br><span class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nl.getLength(); i++) &#123;</span><br><span class="line">      Node node = nl.item(i);</span><br><span class="line">      <span class="keyword">if</span> (isCandidateElement(node) &amp;&amp; nodeNameEquals(node, QUALIFIER_ELEMENT)) &#123;</span><br><span class="line">         parseQualifierElement((Element) node, bd);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parseQualifierElement</span><span class="params">(Element ele, AbstractBeanDefinition bd)</span> </span>&#123;</span><br><span class="line">    String typeName = ele.getAttribute(TYPE_ATTRIBUTE);</span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.hasLength(typeName)) &#123;</span><br><span class="line">        error(<span class="string">"Tag 'qualifier' must have a 'type' attribute"</span>, ele);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.parseState.push(<span class="keyword">new</span> QualifierEntry(typeName));</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        AutowireCandidateQualifier qualifier = <span class="keyword">new</span> AutowireCandidateQualifier(typeName);</span><br><span class="line">        qualifier.setSource(extractSource(ele));</span><br><span class="line">        String value = ele.getAttribute(VALUE_ATTRIBUTE);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasLength(value)) &#123;</span><br><span class="line">            qualifier.setAttribute(AutowireCandidateQualifier.VALUE_KEY, value);</span><br><span class="line">        &#125;</span><br><span class="line">        NodeList nl = ele.getChildNodes();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nl.getLength(); i++) &#123;</span><br><span class="line">            Node node = nl.item(i);</span><br><span class="line">            <span class="keyword">if</span> (isCandidateElement(node) &amp;&amp; nodeNameEquals(node, QUALIFIER_ATTRIBUTE_ELEMENT)) &#123;</span><br><span class="line">                Element attributeEle = (Element) node;</span><br><span class="line">                String attributeName = attributeEle.getAttribute(KEY_ATTRIBUTE);</span><br><span class="line">                String attributeValue = attributeEle.getAttribute(VALUE_ATTRIBUTE);</span><br><span class="line">                <span class="keyword">if</span> (StringUtils.hasLength(attributeName) &amp;&amp; StringUtils.hasLength(attributeValue)) &#123;</span><br><span class="line">                    BeanMetadataAttribute attribute = <span class="keyword">new</span> BeanMetadataAttribute(attributeName, attributeValue);</span><br><span class="line">                    attribute.setSource(extractSource(attributeEle));</span><br><span class="line">                    qualifier.addMetadataAttribute(attribute);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    error(<span class="string">"Qualifier 'attribute' tag must have a 'name' and 'value'"</span>, attributeEle);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        bd.addQualifier(qualifier);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.parseState.pop();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure><p>至此,BeanDefinition的解析完成,此时再回到BeanDefinitionParserDelegate.parseBeanDefinitionElement(org.w3c.dom.Element, org.springframework.beans.factory.config.BeanDefinition)</p><figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> BeanDefinitionHolder <span class="title">parseBeanDefinitionElement</span><span class="params">(Element ele, @Nullable BeanDefinition containingBean)</span> </span>&#123;</span><br><span class="line">   String id = ele.getAttribute(ID_ATTRIBUTE);</span><br><span class="line">   String nameAttr = ele.getAttribute(NAME_ATTRIBUTE);</span><br><span class="line"></span><br><span class="line">   List&lt;String&gt; aliases = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">   <span class="keyword">if</span> (StringUtils.hasLength(nameAttr)) &#123;</span><br><span class="line">      String[] nameArr = StringUtils.tokenizeToStringArray(nameAttr, MULTI_VALUE_ATTRIBUTE_DELIMITERS);</span><br><span class="line">      aliases.addAll(Arrays.asList(nameArr));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   String beanName = id;</span><br><span class="line">   <span class="keyword">if</span> (!StringUtils.hasText(beanName) &amp;&amp; !aliases.isEmpty()) &#123;</span><br><span class="line">      beanName = aliases.remove(<span class="number">0</span>);</span><br><span class="line">      <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">         logger.trace(<span class="string">"No XML 'id' specified - using '"</span> + beanName +</span><br><span class="line">               <span class="string">"' as bean name and "</span> + aliases + <span class="string">" as aliases"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//检查beanName是否重复</span></span><br><span class="line">   <span class="keyword">if</span> (containingBean == <span class="keyword">null</span>) &#123;</span><br><span class="line">      checkNameUniqueness(beanName, aliases, ele);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//点进去</span></span><br><span class="line">   AbstractBeanDefinition beanDefinition = parseBeanDefinitionElement(ele, beanName, containingBean);</span><br><span class="line">   <span class="keyword">if</span> (beanDefinition != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!StringUtils.hasText(beanName)) &#123;</span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (containingBean != <span class="keyword">null</span>) &#123;</span><br><span class="line">               beanName = BeanDefinitionReaderUtils.generateBeanName(</span><br><span class="line">                     beanDefinition, <span class="keyword">this</span>.readerContext.getRegistry(), <span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">               beanName = <span class="keyword">this</span>.readerContext.generateBeanName(beanDefinition);</span><br><span class="line">               <span class="comment">// Register an alias for the plain bean class name, if still possible,</span></span><br><span class="line">               <span class="comment">// if the generator returned the class name plus a suffix.</span></span><br><span class="line">               <span class="comment">// This is expected for Spring 1.2/2.0 backwards compatibility.</span></span><br><span class="line">               String beanClassName = beanDefinition.getBeanClassName();</span><br><span class="line">               <span class="keyword">if</span> (beanClassName != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                     beanName.startsWith(beanClassName) &amp;&amp; beanName.length() &gt; beanClassName.length() &amp;&amp;</span><br><span class="line">                     !<span class="keyword">this</span>.readerContext.getRegistry().isBeanNameInUse(beanClassName)) &#123;</span><br><span class="line">                  aliases.add(beanClassName);</span><br><span class="line">               &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">               logger.trace(<span class="string">"Neither XML 'id' nor 'name' specified - "</span> +</span><br><span class="line">                     <span class="string">"using generated bean name ["</span> + beanName + <span class="string">"]"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            error(ex.getMessage(), ele);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      String[] aliasesArray = StringUtils.toStringArray(aliases);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> BeanDefinitionHolder(beanDefinition, beanName, aliasesArray);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure><p>这里返回的是,又对BeanDefinition做了一层包装,成BeanDefinitionHolder,形成name-&gt;BeanDefinition的映射</p>]]></content>
    
    <summary type="html">
    
      Spring解析xml成BeanDefinition的过程。
    
    </summary>
    
    
      <category term="Spring" scheme="https://lurongjiang.github.io/categories/Spring/"/>
    
    
      <category term="Spring" scheme="https://lurongjiang.github.io/tags/Spring/"/>
    
  </entry>
  
  <entry>
    <title>SpringCloud概述</title>
    <link href="https://lurongjiang.github.io/2019/04/05/SpringCloud/"/>
    <id>https://lurongjiang.github.io/2019/04/05/SpringCloud/</id>
    <published>2019-04-05T01:25:14.000Z</published>
    <updated>2019-05-03T12:15:28.000Z</updated>
    
    <content type="html"><![CDATA[        <h1   id="SpringCloud" >          <span class="heading-link">SpringCloud</span>        </h1>              <h2   id="SpringCloud概述" >          <span class="heading-link">SpringCloud概述</span>        </h2>              <h3   id="官网" >          <span class="heading-link">官网</span>        </h3>      <ul><li><span class="external-link"><a   href="https://spring.io/projects/spring-cloud"  target="_blank" rel="noopener">官网</a><i class="fa fa-external-link"></i></span></li></ul>        <h3   id="主要功能" >          <span class="heading-link">主要功能</span>        </h3>      <p><img src="/images/image/image-20200207192330288.png" alt="img"></p>        <h3   id="常用子项目" >          <span class="heading-link">常用子项目</span>        </h3>      <p><img src="/images/image/image-20200207192553245.png" alt="img"></p>        <h3   id="版本与兼容" >          <span class="heading-link">版本与兼容</span>        </h3>      <ul><li><p>SpringCloud的版本命名</p><ul><li><p><strong>版本命名</strong></p><p>SpringCloud的版本,前半部分(如Hoxton,Greenwich),意思是发布列车(ReleaseTrain),以伦敦地铁的站名命名,因为SpringCloud有很多的子项目,每个项目都有自己的版本管理,按照发布顺序以A,B,C等为首字母依次命名,已经发布的版本顺序为:</p></li></ul><p><code>Angel -&gt; Brixton -&gt; Camden -&gt; Dalston -&gt; Edgware -&gt; Finchley -&gt; Greenwich -&gt; Hoxton</code><br><img src="/images/image/londontuberail-1.png" alt="img"></p></li></ul><p>  后半部分(如SR,SR1,SR2),意思是服务发布(ServiceRelease),即重大Bug修复</p><ul><li><p><strong>版本发布流程</strong></p><p><code>SNAPSHOT -&gt; Mx -&gt; RELEASE -&gt; SRx</code>,其中x就是一些数字序号,例如M1,M2,SR1,SR2.SNAPSHOT为快照版本(开发版本),Mx为里程碑版本,此时并不是正式版本,但是已经接近正式版,经过多个版本迭代之后,发布第一个RELEASE版本,正式版本;在RELEASE版本之后如果有重大bug修复就会发布SR版本</p></li></ul><div class="table-container"><table><thead><tr><th>Hoxton SR1 <strong>CURRENT</strong> <strong>GA</strong></th><th><span class="external-link"><a   href="https://cloud.spring.io/spring-cloud-static/Hoxton.SR1/reference/html/spring-cloud.html"  target="_blank" rel="noopener"> Reference Doc.</a><i class="fa fa-external-link"></i></span></th></tr></thead><tbody><tr><td>Hoxton <strong>SNAPSHOT</strong></td><td><span class="external-link"><a   href="https://spring.io/projects/spring-cloud"  target="_blank" rel="noopener"> Reference Doc.</a><i class="fa fa-external-link"></i></span></td></tr><tr><td>Greenwich SR5 <strong>GA</strong></td><td><span class="external-link"><a   href="https://cloud.spring.io/spring-cloud-static/Greenwich.SR5/"  target="_blank" rel="noopener"> Reference Doc.</a><i class="fa fa-external-link"></i></span></td></tr><tr><td>Greenwich <strong>SNAPSHOT</strong></td><td><span class="external-link"><a   href="https://spring.io/projects/spring-cloud"  target="_blank" rel="noopener"> Reference Doc.</a><i class="fa fa-external-link"></i></span></td></tr></tbody></table></div><hr><ul><li><p>SpringCloud的版本生命周期</p><ul><li><p><strong>版本发布规划</strong></p><p><span class="external-link"><a   href="https://github.com/spring-cloud/spring-cloud-release/milestones"  target="_blank" rel="noopener">https://github.com/spring-cloud/spring-cloud-release/milestones</a><i class="fa fa-external-link"></i></span></p></li><li><p><strong>版本发布记录</strong></p><p><span class="external-link"><a   href="https://github.com/spring-cloud/spring-cloud-release/releases"  target="_blank" rel="noopener">https://github.com/spring-cloud/spring-cloud-release/releases</a><i class="fa fa-external-link"></i></span></p></li><li><p><strong>版本终止声明</strong></p><p><span class="external-link"><a   href="https://spring.io/projects/spring-cloud#overview"  target="_blank" rel="noopener">https://spring.io/projects/spring-cloud#overview</a><i class="fa fa-external-link"></i></span></p></li></ul></li><li><p>SpringBoot与SpringCloud的兼容性</p><ul><li>版本兼容性非常重要<br><span class="external-link"><a   href="https://spring.io/projects/spring-cloud#overview"  target="_blank" rel="noopener">https://spring.io/projects/spring-cloud#overview</a><i class="fa fa-external-link"></i></span></li></ul></li></ul><div class="table-container"><table><thead><tr><th>Release Train</th><th>Boot Version</th></tr></thead><tbody><tr><td>Hoxton</td><td>2.2.x</td></tr><tr><td>Greenwich</td><td>2.1.x</td></tr><tr><td>Finchley</td><td>2.0.x</td></tr><tr><td>Edgware</td><td>1.5.x</td></tr><tr><td>Dalston</td><td>1.5.x</td></tr></tbody></table></div><ul><li>生产环境如何选择选择<ul><li>坚决不适用非稳定版本</li><li>坚决不适用end-of-life版本</li><li>尽量使用最新版本<ul><li>RELEASE版本可以观望/调研,因为是第一个正式版,并没有在生产上得以广泛应用</li><li>SR2之后可以大规模使用</li></ul></li></ul></li></ul>        <h3   id="版本选择" >          <span class="heading-link">版本选择</span>        </h3>      <ul><li>SpringCloud Hoxton SR1</li><li>SpringBoot 2.2.4.RELEASE</li></ul><figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span> </span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework.cloud/spring-cloud-dependencies --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>Hoxton.SR1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></div></figure><p>检查项目是否能运行</p><figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn clean install -U</span><br></pre></td></tr></table></div></figure>        <h2   id="SpringCloud服务注册与发现" >          <span class="heading-link">SpringCloud服务注册与发现</span>        </h2>      <ul><li>使得服务消费者总能找到服务提供者</li></ul>        <h3   id="Consul单机版安装" >          <span class="heading-link">Consul单机版安装</span>        </h3>              <h4   id="Consul下载" >          <span class="heading-link">Consul下载</span>        </h4>      <ul><li>下载Consoule <span class="external-link"><a   href="https://releases.hashicorp.com/consul/1.6.3/consul_1.6.3_linux_amd64.zip"  target="_blank" rel="noopener">https://releases.hashicorp.com/consul/1.6.3/consul_1.6.3_linux_amd64.zip</a><i class="fa fa-external-link"></i></span></li></ul>        <h4   id="需要的端口" >          <span class="heading-link">需要的端口</span>        </h4>      <div class="table-container"><table><thead><tr><th align="left">Use</th><th align="left">Default Ports</th></tr></thead><tbody><tr><td align="left">DNS: The DNS server (TCP and UDP)</td><td align="left">8600</td></tr><tr><td align="left">HTTP: The HTTP API (TCP Only)</td><td align="left">8500</td></tr><tr><td align="left">HTTPS: The HTTPs API</td><td align="left">disabled (8501)*</td></tr><tr><td align="left">gRPC: The gRPC API</td><td align="left">disabled (8502)*</td></tr><tr><td align="left">LAN Serf: The Serf LAN port (TCP and UDP)</td><td align="left">8301</td></tr><tr><td align="left">Wan Serf: The Serf WAN port TCP and UDP)</td><td align="left">8302</td></tr><tr><td align="left">server: Server RPC address (TCP Only)</td><td align="left">8300</td></tr><tr><td align="left">Sidecar Proxy Min: Inclusive min port number to use for automatically assigned sidecar service registrations.</td><td align="left">21000</td></tr><tr><td align="left">Sidecar Proxy Max: Inclusive max port number to use for automatically assigned sidecar service registrations.</td><td align="left">21255</td></tr></tbody></table></div><p>检查端口是否被占用的方法</p><figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Windows:</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果没有结果说明没有被占用</span></span><br><span class="line">netstat -ano| findstr "8500"</span><br><span class="line"></span><br><span class="line">Linux:</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果没有结果说明没有被占用</span></span><br><span class="line">netstat -antp |grep 8500</span><br><span class="line"></span><br><span class="line">macOS:</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果没有结果说明没有被占用</span></span><br><span class="line">netstat -ant | grep 8500</span><br><span class="line">或</span><br><span class="line">lsof -i:8500</span><br></pre></td></tr></table></div></figure>        <h4   id="安装和启动" >          <span class="heading-link">安装和启动</span>        </h4>      <ul><li>解压</li></ul><figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./consul agent -dev -client 0.0.0.0</span><br></pre></td></tr></table></div></figure><ul><li>严重是否成功</li></ul><figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./consul -v</span><br></pre></td></tr></table></div></figure><ul><li>访问Consul首页<code>localhost:8500</code></li></ul><p><strong>启动参数</strong></p><ul><li>-ui 开启ui</li><li>-client 让consul拥有client功能,接受服务注册;0.0.0.0允许任意ip注册,不写只能使用localhost连接</li><li>-dev 以开发模式运行consul</li></ul>        <h3   id="整合Consul" >          <span class="heading-link">整合Consul</span>        </h3>      <ul><li><p>添加依赖</p><figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-consul-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></div></figure></li></ul><ul><li><p>配置</p><figure class="highlight yml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"> <span class="attr">application:</span></span><br><span class="line">    <span class="comment"># 指定注册到consul的服务名称,分隔符不能是下划线</span></span><br><span class="line">    <span class="comment"># 如果服务发现组件是Consul,会强制转换成中划线,导致找不到服务</span></span><br><span class="line">    <span class="comment"># 如果服务发现组件是Ribbon,则因为Ribbon的问题(把默认名称当初虚拟主机名,而虚拟主机名不能用下划线),会造成微服务之间无法调用</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">micro-service-user</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">consul:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.238</span><span class="number">.128</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8500</span></span><br></pre></td></tr></table></div></figure></li><li><p>启动,检查consul ui的服务上线情况</p></li></ul>        <h3   id="Consul健康检查" >          <span class="heading-link">Consul健康检查</span>        </h3>      <p><img src="/images/image/image-20200207231837317.png" alt="img"></p><ul><li>添加健康检查依赖</li></ul><figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></div></figure><ul><li><p>配置</p><figure class="highlight yml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">'*'</span></span><br></pre></td></tr></table></div></figure></li></ul><ul><li><p>端点</p><p><span class="external-link"><a   href="http://localhost:8080/actuator"  target="_blank" rel="noopener">http://localhost:8080/actuator</a><i class="fa fa-external-link"></i></span> 查看端点</p><p><span class="external-link"><a   href="http://localhost:8080/actuator/health"  target="_blank" rel="noopener">http://localhost:8080/actuator/health</a><i class="fa fa-external-link"></i></span> 健康检查</p><p>添加详情配置,可以检查详细的健康情况</p><figure class="highlight yml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">management:</span></span><br><span class="line">    <span class="attr">endpoint:</span></span><br><span class="line">      <span class="attr">health:</span></span><br><span class="line">        <span class="attr">show-details:</span> <span class="string">always</span></span><br></pre></td></tr></table></div></figure><p><img src="/images/image/image-20200207233909996.png" alt="img"></p></li></ul><ul><li><p>简单研究一下健康检查的源码</p><p>以磁盘检查的为例</p><p>健康检查的类都继承了<code>AbstractHealthIndicator</code>抽象类,而<code>AbstractHealthIndicator</code>实现了<code>HealthIndicator</code>接口,所有健康检查实现类都必须实现<code>doHealthCheck(Health.Builder builder)</code>方法</p></li></ul><p><img src="/images/image/image-20200207235333557.png" alt="img"></p><figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DiskSpaceHealthIndicator</span> <span class="keyword">extends</span> <span class="title">AbstractHealthIndicator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Log logger = LogFactory.getLog(DiskSpaceHealthIndicator<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> File path;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> DataSize threshold;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Create a new &#123;<span class="doctag">@code</span> DiskSpaceHealthIndicator&#125; instance.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> path the Path used to compute the available disk space</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> threshold the minimum disk space that should be available</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">DiskSpaceHealthIndicator</span><span class="params">(File path, DataSize threshold)</span> </span>&#123;</span><br><span class="line"><span class="keyword">super</span>(<span class="string">"DiskSpace health check failed"</span>);</span><br><span class="line"><span class="keyword">this</span>.path = path;</span><br><span class="line"><span class="keyword">this</span>.threshold = threshold;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doHealthCheck</span><span class="params">(Health.Builder builder)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//获取可用的空间字节数</span></span><br><span class="line"><span class="keyword">long</span> diskFreeInBytes = <span class="keyword">this</span>.path.getUsableSpace();</span><br><span class="line">        <span class="comment">//如果可用的字节数大于预留字节数阈值则认为是健康的,设置status为UP</span></span><br><span class="line"><span class="keyword">if</span> (diskFreeInBytes &gt;= <span class="keyword">this</span>.threshold.toBytes()) &#123;</span><br><span class="line">builder.up();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//否则任务是不健康的,设置status为DOWN</span></span><br><span class="line">logger.warn(LogMessage.format(<span class="string">"Free disk space below threshold. Available: %d bytes (threshold: %s)"</span>,</span><br><span class="line">diskFreeInBytes, <span class="keyword">this</span>.threshold));</span><br><span class="line">builder.down();</span><br><span class="line">&#125;</span><br><span class="line">        <span class="comment">//输出总空间,可用空间和预留阈值</span></span><br><span class="line">builder.withDetail(<span class="string">"total"</span>, <span class="keyword">this</span>.path.getTotalSpace()).withDetail(<span class="string">"free"</span>, diskFreeInBytes)</span><br><span class="line">.withDetail(<span class="string">"threshold"</span>, <span class="keyword">this</span>.threshold.toBytes());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//这个获取可用字节数还是挺好的,直接利用了File提供的方法</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getUsableSpace</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    SecurityManager sm = System.getSecurityManager();</span><br><span class="line">    <span class="keyword">if</span> (sm != <span class="keyword">null</span>) &#123;</span><br><span class="line">        sm.checkPermission(<span class="keyword">new</span> RuntimePermission(<span class="string">"getFileSystemAttributes"</span>));</span><br><span class="line">        sm.checkRead(path);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (isInvalid()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0L</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//fs是默认的文件系统FileSystem fs = DefaultFileSystem.getFileSystem();</span></span><br><span class="line">    <span class="keyword">return</span> fs.getSpace(<span class="keyword">this</span>, FileSystem.SPACE_USABLE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure><p>健康检查使用了建造者模式,对于不同的健康指标非常方便,值得学习<br><img src="/images/image/image-20200208000623044.png" alt="img"></p><ul><li><p>整合Consul和SpringCloud的actuator</p><p>修改配置</p><figure class="highlight yml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">    <span class="attr">cloud:</span></span><br><span class="line">      <span class="attr">consul:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.238</span><span class="number">.128</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8500</span></span><br><span class="line">        <span class="attr">discovery:</span></span><br><span class="line">          <span class="attr">health-check-path:</span> <span class="string">/actuator/health</span></span><br></pre></td></tr></table></div></figure></li></ul><p>这样启动之后,再检查consul ui就可以发现没有红色的叉了<br><img src="/images/image/image-20200208001532048.png" alt="img"></p><p>其他的健康检查配置<br><img src="/images/image/image-20200208001745953.png" alt="img"></p>        <h3   id="注册课程微服务到Consul" >          <span class="heading-link">注册课程微服务到Consul</span>        </h3>      <ul><li>添加依赖</li></ul><figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-consul-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></div></figure><ul><li>配置</li></ul><figure class="highlight yml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://192.168.238.128:3306/ms?serverTimezone=GMT%2B8&amp;characterEncoding=utf8&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">hikari:</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">lrj</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">lu11221015</span></span><br><span class="line">      <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="comment"># JPA配置</span></span><br><span class="line">  <span class="attr">jpa:</span></span><br><span class="line">    <span class="attr">hibernate:</span></span><br><span class="line">      <span class="attr">ddl-auto:</span> <span class="string">update</span></span><br><span class="line">    <span class="attr">show-sql:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">micro-service-class</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">consul:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.238</span><span class="number">.128</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8500</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">health-check-path:</span> <span class="string">/actuator/health</span></span><br><span class="line"><span class="comment"># 暴露所有的actuator端点</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">'*'</span></span><br><span class="line">  <span class="comment"># 开启健康检查详细信息</span></span><br><span class="line">  <span class="attr">endpoint:</span></span><br><span class="line">    <span class="attr">health:</span></span><br><span class="line">      <span class="attr">show-details:</span> <span class="string">always</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span></span><br></pre></td></tr></table></div></figure><ul><li>重构用户微服务</li></ul><figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> DiscoveryClient discoveryClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">findUserById</span><span class="params">(@PathVariable(<span class="string">"id"</span>)</span> Integer id) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userService.findUserById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"discoveryTest"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">discoveryTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> discoveryClient.getInstances(<span class="string">"micro-service-class"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure><ul><li>访问端点,可以发现不需要指定课程微服务的主机和端口就可以拿到相关信息,实现了服务发现<br><img src="/images/image/image-20200208003543107.png" alt="img"></li></ul>        <h3   id="重构课程微服务" >          <span class="heading-link">重构课程微服务</span>        </h3>      <ul><li><p>原来</p><figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LessonServiceImpl</span> <span class="keyword">implements</span> <span class="title">LessonService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> LessonRepository lessonRepository;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> LessonUserRepository lessonUserRepository;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Lesson <span class="title">buyById</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1. 根据课程id查询课程</span></span><br><span class="line">        Lesson lesson = lessonRepository.findById(id).orElseThrow(() -&gt; <span class="keyword">new</span> IllegalArgumentException(<span class="string">"该课程不存在"</span>));</span><br><span class="line">        <span class="comment">//根据课程查询是否已经购买过</span></span><br><span class="line">        LessonUser lessonUser = lessonUserRepository.findByLessonId(id);</span><br><span class="line">        <span class="keyword">if</span> (lessonUser != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> lesson;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//todo 2.登录之后获取userId</span></span><br><span class="line">        String userId = <span class="string">"1"</span>;</span><br><span class="line">        <span class="comment">// 3. 如果没有购买过,查询用户余额</span></span><br><span class="line">        UserDTO userDTO = restTemplate.getForObject(<span class="string">"http://localhost:8080/user/&#123;userId&#125;"</span>, UserDTO<span class="class">.<span class="keyword">class</span>, <span class="title">userId</span>)</span>;</span><br><span class="line">        <span class="keyword">if</span> (userDTO != <span class="keyword">null</span> &amp;&amp; userDTO.getMoney() != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                userDTO.getMoney().subtract(lesson.getPrice()).doubleValue() &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"余额不足"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//4. 购买逻辑</span></span><br><span class="line">        <span class="comment">//todo 4.1.调用微服务金额扣减接口 4.2.向lesson_user表插入记录</span></span><br><span class="line">        <span class="keyword">return</span> lesson;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure><p>这个写死了主机地址,无法动态获取微服务路径</p></li><li><p>重构</p><figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LessonServiceImpl</span> <span class="keyword">implements</span> <span class="title">LessonService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> LessonRepository lessonRepository;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> LessonUserRepository lessonUserRepository;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> DiscoveryClient discoveryClient;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Lesson <span class="title">buyById</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1. 根据课程id查询课程</span></span><br><span class="line">        Lesson lesson = lessonRepository.findById(id).orElseThrow(() -&gt; <span class="keyword">new</span> IllegalArgumentException(<span class="string">"该课程不存在"</span>));</span><br><span class="line">        <span class="comment">//根据课程查询是否已经购买过</span></span><br><span class="line">        LessonUser lessonUser = lessonUserRepository.findByLessonId(id);</span><br><span class="line">        <span class="keyword">if</span> (lessonUser != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> lesson;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//todo 2.登录之后获取userId</span></span><br><span class="line">        String userId = <span class="string">"1"</span>;</span><br><span class="line">        List&lt;ServiceInstance&gt; instances = discoveryClient.getInstances(<span class="string">"micro-service-user"</span>);</span><br><span class="line">        <span class="keyword">if</span> (instances != <span class="keyword">null</span> &amp;&amp; !instances.isEmpty()) &#123;</span><br><span class="line">            <span class="comment">//todo 需要改进,如果存在多个实例,需要考虑负载均衡</span></span><br><span class="line">            ServiceInstance instance = instances.get(<span class="number">0</span>);</span><br><span class="line">            URI uri = instance.getUri();</span><br><span class="line">            UserDTO userDTO = restTemplate.getForObject(uri + <span class="string">"/user/&#123;userId&#125;"</span>, UserDTO<span class="class">.<span class="keyword">class</span>, <span class="title">userId</span>)</span>;</span><br><span class="line">            <span class="keyword">if</span> (userDTO != <span class="keyword">null</span> &amp;&amp; userDTO.getMoney() != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                    userDTO.getMoney().subtract(lesson.getPrice()).doubleValue() &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"余额不足"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//4. 购买逻辑</span></span><br><span class="line">            <span class="comment">//todo 4.1.调用微服务金额扣减接口 4.2.向lesson_user表插入记录</span></span><br><span class="line">            <span class="keyword">return</span> lesson;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"用户微服务异常,无法购买课程"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure><p>可以动态的获取到用户微服务的地址,请求正常<br><img src="/images/image/image-20200208004838563.png" alt="img"></p></li></ul>        <h3   id="元数据" >          <span class="heading-link">元数据</span>        </h3>      <p>Consul是没有元数据的概念的,所以SpringCloud做了个适配,在consul下设置tags作为元数据.</p><p>元数据可以对微服务添加描述,标识,例如机房在哪里,这样可以进行就近判断,或者当就近机房不可用时才检查远程机房,当两者都不可用时才认为服务不可用等实现容灾或者跨机房</p><ul><li><p>配置</p><figure class="highlight yml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">consul:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.238</span><span class="number">.128</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8500</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">health-check-path:</span> <span class="string">/actuator/health</span></span><br><span class="line">        <span class="attr">tags:</span> <span class="string">JiFang=Beijing,JiFang=Shanghai</span></span><br></pre></td></tr></table></div></figure></li><li><p>实现机房选择</p><figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"discoveryTest"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">discoveryTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;ServiceInstance&gt; instances = discoveryClient.getInstances(<span class="string">"micro-service-class"</span>);</span><br><span class="line">    <span class="keyword">if</span> (instances != <span class="keyword">null</span>) &#123;</span><br><span class="line">        List&lt;ServiceInstance&gt; shanghaiInstances = instances.stream()</span><br><span class="line">                .filter(s -&gt; s.getMetadata().containsKey(<span class="string">"Shanghai"</span>)).collect(Collectors.toList());</span><br><span class="line">        <span class="keyword">if</span> (!shanghaiInstances.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> shanghaiInstances;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> instances;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure></li></ul>]]></content>
    
    <summary type="html">
    
      SpringCloud相关介绍
    
    </summary>
    
    
      <category term="SpringCloud" scheme="https://lurongjiang.github.io/categories/SpringCloud/"/>
    
    
      <category term="SpringCloud" scheme="https://lurongjiang.github.io/tags/SpringCloud/"/>
    
  </entry>
  
  <entry>
    <title>Flume使用教程</title>
    <link href="https://lurongjiang.github.io/2019/04/04/Flume/"/>
    <id>https://lurongjiang.github.io/2019/04/04/Flume/</id>
    <published>2019-04-04T07:14:54.000Z</published>
    <updated>2019-04-04T10:45:45.000Z</updated>
    
    <content type="html"><![CDATA[        <h1   id="Flume" >          <span class="heading-link">Flume</span>        </h1>      <p>Flume是高可靠,高可用的,分布式的海量日志收集,聚合和传输的系统,</p>        <h2   id="数据流模型" >          <span class="heading-link">数据流模型</span>        </h2>      <p><img src="/images/image/image-20200225205404604.png" alt="image-20200225205404604"></p><p>A Flume event is defined as a unit of data flow having a byte payload and an optional set of string attributes. A Flume agent is a (JVM) process that hosts the components through which events flow from an external source to the next destination (hop).</p><p>A Flume source consumes events delivered to it by an external source like a web server. The external source sends events to Flume in a format that is recognized by the target Flume source. For example, an Avro Flume source can be used to receive Avro events from Avro clients or other Flume agents in the flow that send events from an Avro sink. A similar flow can be defined using a Thrift Flume Source to receive events from a Thrift Sink or a Flume Thrift Rpc Client or Thrift clients written in any language generated from the Flume thrift protocol.When a Flume source receives an event, it stores it into one or more channels. The channel is a passive store that keeps the event until it’s consumed by a Flume sink. The file channel is one example – it is backed by the local filesystem. The sink removes the event from the channel and puts it into an external repository like HDFS (via Flume HDFS sink) or forwards it to the Flume source of the next Flume agent (next hop) in the flow. The source and sink within the given agent run asynchronously with the events staged in the channel.</p><ul><li><p>Flume中,数据流的单位称为事件(event)</p><p>它具有一个字节的有效载荷,还可以携带一系列的字符串属性.</p></li><li><p>Flume中Agent是一个JVM进程</p><p>Agent由一系列的组件组成,通过这些组件,将事件从外部数据源传到另一个位置</p></li><li><p>Flume源端部分(source)消费着来至外部数据源的事件,例如web服务端的</p><p>外部数据源需要以目标flume源端能够识别的形式发出.例如，Avro类型的flume源端可用于接收从Avro客户端发出的事件,或从其他的Avro类型的Flume发送端(sink)发出的事件</p></li><li><p>flume源端接收事件后,会将事件存入一个或者多个管道(Channel)</p><p>Flume的管道存储所源端接收到的事件,直到它Flume发送端消费了这些事件.File Channel就是一个例子,它将事件备份在本地文件系统中</p></li><li><p>flume的发送端消费着Channel中的事件,并把它推送HDFS等外部仓库中(通过HDFS类型的Sink发送)</p></li></ul>        <h2   id="Agent的三个组件" >          <span class="heading-link">Agent的三个组件</span>        </h2>      <p><strong>Source</strong></p><p>数据源</p><p><strong>Channel</strong> </p><p>通道,缓冲</p><p>数据存在哪里</p><p><strong>Sink</strong> </p><p>数据输出到哪里</p>        <h2   id="下载" >          <span class="heading-link">下载</span>        </h2>      <figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://archive.cloudera.com/cdh5/cdh/5/flume-ng-1.6.0-cdh5.16.2.tar.gz</span><br></pre></td></tr></table></div></figure>        <h2   id="配置" >          <span class="heading-link">配置</span>        </h2>      <p>所有的配置都参考官网的配置,只要配置agent,source,channel,sink即可</p><p><span class="external-link"><a   href="http://flume.apache.org/releases/content/1.9.0/FlumeUserGuide.html#setting-up-an-agent"  target="_blank" rel="noopener">http://flume.apache.org/releases/content/1.9.0/FlumeUserGuide.html#setting-up-an-agent</a><i class="fa fa-external-link"></i></span></p><p>其中所有的粗体都是必须要配置的,其他普通的属性是可选的</p>        <h3   id="样例" >          <span class="heading-link">样例</span>        </h3>      <p>为了便于配置,可以先把这个模板copy到notepad,根据需要改一下就可以</p><figure class="highlight properties"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># example.conf: A single-node Flume configuration</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Name the components on this agent</span></span><br><span class="line"><span class="comment"># agent a1的 source 的名字设置为r1</span></span><br><span class="line"><span class="meta">a1.sources</span> = <span class="string">r1 </span></span><br><span class="line"><span class="comment"># agent a1的 sinks 的名字设置为k1</span></span><br><span class="line"><span class="meta">a1.sinks</span> = <span class="string">k1</span></span><br><span class="line"><span class="comment"># agent a1的 channels 的名字设置为c1</span></span><br><span class="line"><span class="meta">a1.channels</span> = <span class="string">c1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Describe/configure the source</span></span><br><span class="line"><span class="comment"># agent a1的 source r1 的类型设置为netcat</span></span><br><span class="line"><span class="meta">a1.sources.r1.type</span> = <span class="string">netcat</span></span><br><span class="line"><span class="comment"># agent a1的 source r1 的绑定的host和port</span></span><br><span class="line"><span class="meta">a1.sources.r1.bind</span> = <span class="string">localhost</span></span><br><span class="line"><span class="meta">a1.sources.r1.port</span> = <span class="string">44444</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Describe the sink</span></span><br><span class="line"><span class="comment"># agent a1的 sinks k1 的类型为logger类型,也就是控制台输出</span></span><br><span class="line"><span class="meta">a1.sinks.k1.type</span> = <span class="string">logger</span></span><br><span class="line"><span class="attr">c</span></span><br><span class="line"><span class="comment"># Use a channel which buffers events in memory</span></span><br><span class="line"><span class="comment"># agent a1的 channels c1 的类型为memory类型,也就是基于内存进行缓冲,所以flume对内存还是由一定要求的</span></span><br><span class="line"><span class="meta">a1.channels.c1.type</span> = <span class="string">memory</span></span><br><span class="line"><span class="meta">a1.channels.c1.capacity</span> = <span class="string">1000</span></span><br><span class="line"><span class="meta">a1.channels.c1.transactionCapacity</span> = <span class="string">100</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Bind the source and sink to the channel</span></span><br><span class="line"><span class="comment"># agent a1的 source,channel,sink如何连接</span></span><br><span class="line"><span class="comment"># 这里配置了agent a1的source r1的channel为c1</span></span><br><span class="line"><span class="comment"># 也就是说,事件从在被sink消费之前被保存在c1的channel中</span></span><br><span class="line"><span class="meta">a1.sources.r1.channels</span> = <span class="string">c1</span></span><br><span class="line"><span class="comment"># 这里配置了agent a1的sink k1的channel为c1,</span></span><br><span class="line"><span class="comment"># 也就是说agent a1的sink k1要从c1 channel消费事件</span></span><br><span class="line"><span class="meta">a1.sinks.k1.channel</span> = <span class="string">c1</span></span><br></pre></td></tr></table></div></figure><p><strong>参数说明</strong></p><ul><li><p>a1</p><p>这个是agent的名字,启动flume必须指定agent的名字,独一无二的即可,因为agent是一个独立jvm进程</p></li></ul>        <h3   id="netcat样例" >          <span class="heading-link">netcat样例</span>        </h3>      <p>netcat.conf</p><figure class="highlight properties"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">myConsoleAgent.sources</span> = <span class="string">source1</span></span><br><span class="line"><span class="meta">myConsoleAgent.sinks</span> = <span class="string">sink1</span></span><br><span class="line"><span class="meta">myConsoleAgent.channels</span> = <span class="string">channel1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据从哪里来</span></span><br><span class="line"><span class="meta">myConsoleAgent.sources.source1.type</span> = <span class="string">netcat</span></span><br><span class="line"><span class="meta">myConsoleAgent.sources.source1.bind</span> = <span class="string">localhost</span></span><br><span class="line"><span class="meta">myConsoleAgent.sources.source1.port</span> = <span class="string">44444</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出到哪里去</span></span><br><span class="line"><span class="meta">myConsoleAgent.sinks.sink1.type</span> = <span class="string">logger</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取数据之后先放到哪里</span></span><br><span class="line"><span class="meta">myConsoleAgent.channels.channel1.type</span> = <span class="string">memory</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将source,channel,sink连接起来</span></span><br><span class="line"><span class="meta">myConsoleAgent.sources.source1.channels</span> = <span class="string">channel1</span></span><br><span class="line"><span class="meta">myConsoleAgent.sinks.sink1.channel</span> = <span class="string">channel1</span></span><br></pre></td></tr></table></div></figure><p>启动agent</p><figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$FLUME_HOME</span>/bin/flume-ng \</span><br><span class="line">--conf <span class="variable">$FLUME_HOME</span> \</span><br><span class="line">--conf-file ./netcat.conf \</span><br><span class="line">--name myConsoleAgent</span><br></pre></td></tr></table></div></figure>        <h3   id="exec-命令行输入" >          <span class="heading-link">exec 命令行输入</span>        </h3>      <p>exec.conf</p><figure class="highlight properties"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">myConsoleAgent.sources</span> = <span class="string">source1</span></span><br><span class="line"><span class="meta">myConsoleAgent.sinks</span> = <span class="string">sink1</span></span><br><span class="line"><span class="meta">myConsoleAgent.channels</span> = <span class="string">channel1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据从哪里来</span></span><br><span class="line"><span class="meta">myConsoleAgent.sources.source1.type</span> = <span class="string">exec</span></span><br><span class="line"><span class="meta">myConsoleAgent.sources.source1.command</span> = <span class="string">tail -F /usr/software/flume-1.6.0-cdh5.16.2/input/exec.log </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出到哪里去</span></span><br><span class="line"><span class="meta">myConsoleAgent.sinks.sink1.type</span> = <span class="string">hdfs</span></span><br><span class="line"><span class="meta">myConsoleAgent.sinks.sink1.hdfs.path</span> = <span class="string">hdfs://hadoop001:9000/flume/exec</span></span><br><span class="line"><span class="meta">myConsoleAgent.sinks.sink1.hdfs.batchSize</span> = <span class="string">10</span></span><br><span class="line"><span class="meta">myConsoleAgent.sinks.sink1.hdfs.fileType</span> = <span class="string">DataStream </span></span><br><span class="line"><span class="meta">myConsoleAgent.sinks.sink1.writeFormat</span> = <span class="string">Text </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取数据之后先放到哪里</span></span><br><span class="line"><span class="meta">myConsoleAgent.channels.channel1.type</span> = <span class="string">memory</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将source,channel,sink连接起来</span></span><br><span class="line"><span class="meta">myConsoleAgent.sources.source1.channels</span> = <span class="string">channel1</span></span><br><span class="line"><span class="meta">myConsoleAgent.sinks.sink1.channel</span> = <span class="string">channel1</span></span><br></pre></td></tr></table></div></figure><p>启动agent</p><figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$FLUME_HOME</span>/bin/flume-ng \</span><br><span class="line">--conf <span class="variable">$FLUME_HOME</span> \</span><br><span class="line">--conf-file ./exec.conf \</span><br><span class="line">--name myConsoleAgent</span><br></pre></td></tr></table></div></figure>        <h3   id="spooldir-监听文件夹" >          <span class="heading-link">spooldir 监听文件夹</span>        </h3>      <p>spool.conf</p><figure class="highlight properties"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">myConsoleAgent.sources</span> = <span class="string">source1</span></span><br><span class="line"><span class="meta">myConsoleAgent.sinks</span> = <span class="string">sink1</span></span><br><span class="line"><span class="meta">myConsoleAgent.channels</span> = <span class="string">channel1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据从哪里来</span></span><br><span class="line"><span class="meta">myConsoleAgent.sources.source1.type</span> = <span class="string">spooldir</span></span><br><span class="line"><span class="meta">myConsoleAgent.sources.source1.spoolDir</span> = <span class="string">/usr/software/flume-1.6.0-cdh5.16.2/input</span></span><br><span class="line"><span class="meta">memory.sources.source1.includePattern</span> = <span class="string">*.log</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出到哪里去</span></span><br><span class="line"><span class="meta">myConsoleAgent.sinks.sink1.type</span> = <span class="string">hdfs</span></span><br><span class="line"><span class="meta">myConsoleAgent.sinks.sink1.hdfs.path</span> = <span class="string">hdfs://hadoop001:9000/flume/spool/%Y%m%d%H%M</span></span><br><span class="line"><span class="meta">myConsoleAgent.sinks.sink1.hdfs.batchSize</span> = <span class="string">10</span></span><br><span class="line"><span class="meta">myConsoleAgent.sinks.sink1.hdfs.fileType</span> = <span class="string">DataStream </span></span><br><span class="line"><span class="meta">myConsoleAgent.sinks.sink1.writeFormat</span> = <span class="string">Text </span></span><br><span class="line"><span class="meta">myConsoleAgent.sinks.sink1.hdfs.rollInterval</span>=<span class="string">30</span></span><br><span class="line"><span class="meta">myConsoleAgent.sinks.sink1.hdfs.rollSize</span>=<span class="string">1024</span></span><br><span class="line"><span class="meta">myConsoleAgent.sinks.sink1.hdfs.hdfs.rollCount</span>=<span class="string">100</span></span><br><span class="line"><span class="meta">myConsoleAgent.sinks.sink1.hdfs.useLocalTimeStamp</span> =<span class="string">true</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取数据之后先放到哪里</span></span><br><span class="line"><span class="meta">myConsoleAgent.channels.channel1.type</span> = <span class="string">memory</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将source,channel,sink连接起来</span></span><br><span class="line"><span class="meta">myConsoleAgent.sources.source1.channels</span> = <span class="string">channel1</span></span><br><span class="line"><span class="meta">myConsoleAgent.sinks.sink1.channel</span> = <span class="string">channel1</span></span><br></pre></td></tr></table></div></figure><p>启动agent</p><figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$FLUME_HOME</span>/bin/flume-ng \</span><br><span class="line">--conf <span class="variable">$FLUME_HOME</span> \</span><br><span class="line">--conf-file ./spool.conf \</span><br><span class="line">--name myConsoleAgent</span><br></pre></td></tr></table></div></figure>        <h3   id="taildir-监听文件夹-最常用的" >          <span class="heading-link">taildir 监听文件夹(最常用的)</span>        </h3>      <p>这个监听最常用,也是必须掌握的,因为spoolDir并没有偏移量的概念,使用有很大的局限性</p><p>spooldir的缺点</p><ul><li>每次采集完成之后,会在文件结尾设置Complete的后缀,而且之后不能再使用相同的文件名,否则报错</li><li>采集完之后的文件不能再次写入,否则报错</li></ul><p>而taildir很好的使用了偏移量的概念,记录在一个json文件中,可以实现断点还原</p><p>taildir.conf</p><figure class="highlight properties"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">myConsoleAgent.sources</span> = <span class="string">source1</span></span><br><span class="line"><span class="meta">myConsoleAgent.sinks</span> = <span class="string">sink1</span></span><br><span class="line"><span class="meta">myConsoleAgent.channels</span> = <span class="string">channel1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据从哪里来</span></span><br><span class="line"><span class="meta">myConsoleAgent.sources.source1.type</span> = <span class="string">TAILDIR</span></span><br><span class="line"><span class="meta">myConsoleAgent.sources.source1.filegroups</span> = <span class="string">f1 f2</span></span><br><span class="line"><span class="meta">myConsoleAgent.sources.source1.filegroups.f1</span> = <span class="string">input/taildir/test1/hello.txt</span></span><br><span class="line"><span class="meta">myConsoleAgent.sources.source1.headers.f1.headerKey1</span> = <span class="string">value1</span></span><br><span class="line"><span class="meta">myConsoleAgent.sources.source1.filegroups.f2</span> = <span class="string">input/taildir/test2/.*.log</span></span><br><span class="line"><span class="meta">myConsoleAgent.sources.source1.headers.f2.headerKey1</span> = <span class="string">value2-1</span></span><br><span class="line"><span class="meta">myConsoleAgent.sources.source1.headers.f2.headerKey2</span> = <span class="string">value2-2</span></span><br><span class="line"><span class="meta">myConsoleAgent..sources.source1.maxBatchCount</span> = <span class="string">1000</span></span><br><span class="line"><span class="meta">myConsoleAgent.sources.source1.fileHeader</span> = <span class="string">true</span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出到哪里去</span></span><br><span class="line"><span class="meta">myConsoleAgent.sinks.sink1.type</span> = <span class="string">hdfs</span></span><br><span class="line"><span class="meta">myConsoleAgent.sinks.sink1.hdfs.path</span> = <span class="string">hdfs://hadoop001:9000/flume/tailDir/%Y%m%d%H%M</span></span><br><span class="line"><span class="meta">myConsoleAgent.sinks.sink1.hdfs.batchSize</span> = <span class="string">100</span></span><br><span class="line"><span class="meta">myConsoleAgent.sinks.sink1.hdfs.fileType</span> = <span class="string">DataStream </span></span><br><span class="line"><span class="meta">myConsoleAgent.sinks.sink1.writeFormat</span> = <span class="string">Text </span></span><br><span class="line"><span class="meta">myConsoleAgent.sinks.sink1.hdfs.rollInterval</span>=<span class="string">30</span></span><br><span class="line"><span class="meta">myConsoleAgent.sinks.sink1.hdfs.rollSize</span>=<span class="string">10240</span></span><br><span class="line"><span class="meta">myConsoleAgent.sinks.sink1.hdfs.hdfs.rollCount</span>=<span class="string">100</span></span><br><span class="line"><span class="meta">myConsoleAgent.sinks.sink1.hdfs.useLocalTimeStamp</span> =<span class="string">true</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取数据之后先放到哪里</span></span><br><span class="line"><span class="meta">myConsoleAgent.channels.channel1.type</span> = <span class="string">memory</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将source,channel,sink连接起来</span></span><br><span class="line"><span class="meta">myConsoleAgent.sources.source1.channels</span> = <span class="string">channel1</span></span><br><span class="line"><span class="meta">myConsoleAgent.sinks.sink1.channel</span> = <span class="string">channel1</span></span><br></pre></td></tr></table></div></figure><p>启动agent</p><figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$FLUME_HOME</span>/bin/flume-ng \</span><br><span class="line">--conf <span class="variable">$FLUME_HOME</span> \</span><br><span class="line">--conf-file ./taildir.conf \</span><br><span class="line">--name myConsoleAgent</span><br></pre></td></tr></table></div></figure>]]></content>
    
    <summary type="html">
    
      Flume的简单使用教程,分别列了几个常见的Flume配置
    
    </summary>
    
    
      <category term="Flume" scheme="https://lurongjiang.github.io/categories/Flume/"/>
    
    
      <category term="Flume" scheme="https://lurongjiang.github.io/tags/Flume/"/>
    
  </entry>
  
  <entry>
    <title>Azkaband的安装和使用</title>
    <link href="https://lurongjiang.github.io/2019/04/03/Azkaband%E7%9A%84%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/"/>
    <id>https://lurongjiang.github.io/2019/04/03/Azkaband%E7%9A%84%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8/</id>
    <published>2019-04-03T06:24:04.000Z</published>
    <updated>2019-04-05T01:27:49.000Z</updated>
    
    <content type="html"><![CDATA[        <h1   id="Azkaband的安装和使用" >          <span class="heading-link">Azkaband的安装和使用</span>        </h1>      <p>Azkaban可以设计很复杂的工作流,解决任务之间的依赖关系,还是很方便的</p><p>Azkaban是一个由LinkedIn公司开发的分布式工作流管理框架,主要是为了解决Hadoop工作之间的依赖关系.例如,我们需要有顺序地执行任务,把ETL任务的数据导入到RMBS中,以提供数据分析支持.</p><p><img src="/images/image/image-20200220101138796.png" alt="image-20200220101138796"></p><ul><li>Azkaban是一个开源的工作流管理框架</li><li>Azkaban是由LinkedIn(领英,还有一个比较出名的产品Kafka)公司创建,用来管理批处理工作流的任务调度</li><li>Azkaban提供了WebUI接口来维护工作流</li></ul>        <h2   id="Feature" >          <span class="heading-link">Feature</span>        </h2>      <ul><li><p>Compatible with any version of Hadoop</p><p>兼容Hadoop各个版本</p></li><li><p>Easy to use web UI</p><p>提供易用的WebUI</p></li><li><p>Simple web and http workflow uploads</p><p>web和http方式上传工作流(这个被诟病了,应该提供拖拉拽的,写了配置还要上传,确实不方便)</p></li><li><p>Project workspaces</p></li><li><p>Scheduling of workflows</p><p>工作流调度</p></li><li><p>Modular and pluginable</p><p>模块化,可插拔</p></li><li><p>Authentication and Authorization</p><p>提供认证和授权</p></li><li><p>Tracking of user actions</p></li><li><p>Email alerts on failure and successes</p><p>任务失败和成功邮件告警</p></li><li><p>SLA alerting and auto killing</p><p>SLA告警和自动结束任务</p></li><li><p>Retrying of failed jobs</p><p>任务失败重试</p></li></ul>        <h2   id="版本选择" >          <span class="heading-link">版本选择</span>        </h2>      <ul><li>2.x    基本可以不用看了</li><li>3.x    当前推荐的</li></ul>        <h2   id="模式" >          <span class="heading-link">模式</span>        </h2>      <ul><li><p>stand alone mode(or solo-server) 单个</p><ul><li><p>web server和executor server运行在同一个进程里</p></li><li><p>数据存储的数据库是内嵌的,不需要自己安装</p></li><li><p>主要使用在小规模场景中</p></li></ul></li><li><p>Multiple executor mode </p><ul><li>多用于生产</li><li>存储的DB应该是一个主从结构的MySQL</li><li>web server和executor server运行在不同的host上,这样升级和维护时,互不影响</li></ul></li></ul>        <h2   id="下载和编译" >          <span class="heading-link">下载和编译</span>        </h2>      <p>Azkban不直接提供安装包,需要自己从源码编译</p><p>Azkaban是Gradle构建的,Java版本需要1.8以上</p><figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/azkaban/azkaban/archive/3.81.0.tar.gz</span><br><span class="line">tar -zxvf ./3.81.0.tar.gz -C /usr/software</span><br><span class="line"><span class="built_in">cd</span> /usr/software/azkaban-3.81.0</span><br><span class="line">./gradlew build installDist -x <span class="built_in">test</span></span><br></pre></td></tr></table></div></figure><p>这个需要git,如果不安装会报错Failed to apply plugin [id ‘com.cinnober.gradle.semver-git’]</p><p><img src="/images/image/image-20200220105916429.png" alt="image-20200220105916429"></p><p>所以先得安装git</p><figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y git</span><br></pre></td></tr></table></div></figure><p>执行有报错….缺少g++:Could not find Linker ‘g++’ in system path</p><p><img src="/images/image/image-20200220135312805.png" alt="image-20200220135312805"></p><p>好吧在安装g++</p><figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install g++</span><br><span class="line">sudo yum install -y gcc-c++*</span><br></pre></td></tr></table></div></figure>        <h2   id="部署" >          <span class="heading-link">部署</span>        </h2>      <p>编译完成后会出现3个目录,一个是azkaban-solo-server,azkaban-web-server,azkaban-exec-server,分别对应了单机版的azkaban-executor-server,azkaban-web-server和多实例的azkaban-executor-server</p><p>我们只需要把他们目录下的build/distributions的压缩包拷贝出来就行</p>        <h3   id="单机版" >          <span class="heading-link">单机版</span>        </h3>      <figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf ./azkaban-solo-server-0.1.0-SNAPSHOT.tar.gz</span><br></pre></td></tr></table></div></figure><p>修改azkban的配置文件azkaban.properties,用默认也可以</p><figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi conf/azkaban.properties</span><br></pre></td></tr></table></div></figure><figure class="highlight properties"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Azkaban Personalization Settings</span></span><br><span class="line"><span class="comment"># 设置azkban的名称,这个是UI首页左上角,图标右侧上方的文字</span></span><br><span class="line"><span class="meta">azkaban.name</span>=<span class="string">LRJ</span></span><br><span class="line"><span class="comment"># UI首页左上角,图标右侧下方的文字</span></span><br><span class="line"><span class="meta">azkaban.label</span>=<span class="string">MyAzkaban</span></span><br><span class="line"><span class="meta">azkaban.color</span>=<span class="string">#FF3601</span></span><br><span class="line"><span class="meta">azkaban.default.servlet.path</span>=<span class="string">/index</span></span><br><span class="line"><span class="meta">web.resource.dir</span>=<span class="string">web/</span></span><br><span class="line"><span class="comment"># 修改一下时区,免得调度时间不对</span></span><br><span class="line"><span class="meta">default.timezone.id</span>=<span class="string">Asia/Shanghai</span></span><br><span class="line"><span class="comment"># Azkaban UserManager class</span></span><br><span class="line"><span class="meta">user.manager.class</span>=<span class="string">azkaban.user.XmlUserManager</span></span><br><span class="line"><span class="meta">user.manager.xml.file</span>=<span class="string">conf/azkaban-users.xml</span></span><br><span class="line"><span class="comment"># Loader for projects</span></span><br><span class="line"><span class="meta">executor.global.properties</span>=<span class="string">conf/global.properties</span></span><br><span class="line"><span class="meta">azkaban.project.dir</span>=<span class="string">projects</span></span><br><span class="line"><span class="meta">database.type</span>=<span class="string">h2</span></span><br><span class="line"><span class="meta">h2.path</span>=<span class="string">./h2</span></span><br><span class="line"><span class="meta">h2.create.tables</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"># Velocity dev mode</span></span><br><span class="line"><span class="meta">velocity.dev.mode</span>=<span class="string">false</span></span><br><span class="line"><span class="comment"># Azkaban Jetty server properties.</span></span><br><span class="line"><span class="meta">jetty.use.ssl</span>=<span class="string">false</span></span><br><span class="line"><span class="meta">jetty.maxThreads</span>=<span class="string">25</span></span><br><span class="line"><span class="comment"># Web端口,端口占用的时候改一改</span></span><br><span class="line"><span class="meta">jetty.port</span>=<span class="string">8081</span></span><br><span class="line"><span class="comment"># Azkaban Executor settings</span></span><br><span class="line"><span class="meta">executor.port</span>=<span class="string">12321</span></span><br><span class="line"><span class="comment"># mail settings</span></span><br><span class="line"><span class="comment"># 邮件服务器设置</span></span><br><span class="line"><span class="meta">mail.sender</span>=<span class="string"></span></span><br><span class="line"><span class="meta">mail.host</span>=<span class="string"></span></span><br><span class="line"><span class="comment"># 开启SSL设置</span></span><br><span class="line"><span class="comment"># User facing web server configurations used to construct the user facing server URLs. They are useful when there is a reverse proxy between Azkaban web servers and users.</span></span><br><span class="line"><span class="comment"># enduser -&gt; myazkabanhost:443 -&gt; proxy -&gt; localhost:8081</span></span><br><span class="line"><span class="comment"># when this parameters set then these parameters are used to generate email links.</span></span><br><span class="line"><span class="comment"># if these parameters are not set then jetty.hostname, and jetty.port(if ssl configured jetty.ssl.port) are used.</span></span><br><span class="line"><span class="comment"># azkaban.webserver.external_hostname=myazkabanhost.com</span></span><br><span class="line"><span class="comment"># azkaban.webserver.external_ssl_port=443</span></span><br><span class="line"><span class="comment"># azkaban.webserver.external_port=8081</span></span><br><span class="line"><span class="comment"># 全局邮箱设置</span></span><br><span class="line"><span class="meta">job.failure.email</span>=<span class="string"></span></span><br><span class="line"><span class="meta">job.success.email</span>=<span class="string"></span></span><br><span class="line"><span class="meta">lockdown.create.projects</span>=<span class="string">false</span></span><br><span class="line"><span class="meta">cache.directory</span>=<span class="string">cache</span></span><br><span class="line"><span class="comment"># JMX stats</span></span><br><span class="line"><span class="meta">jetty.connector.stats</span>=<span class="string">true</span></span><br><span class="line"><span class="meta">executor.connector.stats</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"># Azkaban plugin settings</span></span><br><span class="line"><span class="comment"># 插件设置</span></span><br><span class="line"><span class="meta">azkaban.jobtype.plugin.dir</span>=<span class="string">plugins/jobtypes</span></span><br><span class="line"><span class="comment"># Number of executions to be displayed</span></span><br><span class="line"><span class="meta">azkaban.display.execution_page_size</span>=<span class="string">16</span></span><br><span class="line"><span class="meta">azkaban.use.multiple.executors</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"># Azkaban Ramp Feature Configuration</span></span><br><span class="line"><span class="comment">#Ramp Feature Related</span></span><br><span class="line"><span class="meta">azkaban.ramp.enabled</span>=<span class="string">true</span></span><br><span class="line"><span class="meta">azkaban.ramp.status.polling.enabled</span>=<span class="string">true</span></span><br><span class="line"><span class="meta">azkaban.ramp.status.polling.interval.min</span>=<span class="string">30</span></span><br><span class="line"><span class="meta">azkaban.ramp.status.push.interval.threshold</span>=<span class="string">15</span></span><br><span class="line"><span class="meta">azkaban.ramp.status.pull.interval.threshold</span>=<span class="string">100</span></span><br></pre></td></tr></table></div></figure><p>添加个用户名和密码,也可以使用默认的</p><figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">azkaban-users</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">user</span> <span class="attr">groups</span>=<span class="string">"azkaban"</span> <span class="attr">password</span>=<span class="string">"azkaban"</span> <span class="attr">roles</span>=<span class="string">"admin"</span> <span class="attr">username</span>=<span class="string">"azkaban"</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--添加自己的用户--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">user</span> <span class="attr">groups</span>=<span class="string">"lurongjiang"</span> <span class="attr">password</span>=<span class="string">"lurongjiang"</span> <span class="attr">roles</span>=<span class="string">"admin"</span> <span class="attr">username</span>=<span class="string">"lurongjiang"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">user</span> <span class="attr">password</span>=<span class="string">"metrics"</span> <span class="attr">roles</span>=<span class="string">"metrics"</span> <span class="attr">username</span>=<span class="string">"metrics"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">role</span> <span class="attr">name</span>=<span class="string">"admin"</span> <span class="attr">permissions</span>=<span class="string">"ADMIN"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">role</span> <span class="attr">name</span>=<span class="string">"metrics"</span> <span class="attr">permissions</span>=<span class="string">"METRICS"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">azkaban-users</span>&gt;</span></span><br></pre></td></tr></table></div></figure>        <h3   id="启动" >          <span class="heading-link">启动</span>        </h3>      <figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./bin/start-solo.sh</span><br><span class="line"><span class="comment"># 查看一下</span></span><br><span class="line">jps -m</span><br></pre></td></tr></table></div></figure><p>访问webUI端口就可以显示了,可以看到我们改的两个位置</p><p><img src="/images/image/image-20200220185537929.png" alt="image-20200220185537929"></p><p>输入用户名和密码就就可以进去了</p><p><img src="/images/image/image-20200220185655686.png" alt="image-20200220185655686"></p>        <h3   id="使用" >          <span class="heading-link">使用</span>        </h3>      <p>参考<span class="external-link"><a   href="https://azkaban.readthedocs.io/en/latest/createFlows.html"  target="_blank" rel="noopener">Create Flows</a><i class="fa fa-external-link"></i></span></p><ul><li><p>创建一个名字为<code>flow20.project</code>的文件,写入内容:</p><figure class="highlight yml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">azkaban-flow-version:</span> <span class="number">2.0</span></span><br></pre></td></tr></table></div></figure></li></ul><ul><li><p>创建一个<code>basic.flow</code>的文件,写入内容:</p><figure class="highlight yml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">nodes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">jobA</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">command</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">echo</span> <span class="string">"This is an echoed text."</span></span><br></pre></td></tr></table></div></figure></li><li><p>把两个文件打个zip包</p></li></ul><p><img src="/images/image/image-20200220190504445.png" alt="image-20200220190504445"></p><ul><li>在WebUI中创建工程</li></ul><p><img src="/images/image/image-20200220190731303.png" alt="image-20200220190731303"></p><ul><li>上传打包好的附件</li></ul><p><img src="/images/image/image-20200220190849991.png" alt="image-20200220190849991"></p><p>这样project就有任务了</p><p><img src="/images/image/image-20200220190959064.png" alt="image-20200220190959064"></p><p>点击运行后就有任务执行历史了</p><p><img src="/images/image/image-20200220191106770.png" alt="image-20200220191106770"></p>        <h3   id="依赖型任务" >          <span class="heading-link">依赖型任务</span>        </h3>      <p>依赖型可以使用dependsOn来进行关联</p><figure class="highlight yml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">nodes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">jobC</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">noop</span></span><br><span class="line">    <span class="comment"># jobC depends on jobA and jobB</span></span><br><span class="line">    <span class="attr">dependsOn:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">jobA</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">jobB</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">jobA</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">command</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">echo</span> <span class="string">"This is an echoed text."</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">jobB</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">command</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">pwd</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">jobD</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">command</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">echo</span> <span class="string">'I am D job'</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">jobE</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">command</span></span><br><span class="line">    <span class="attr">dependsOn:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">jobC</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">jobD</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">echo</span> <span class="string">'I am E'</span></span><br></pre></td></tr></table></div></figure><p>这样就配置三个任务,其中A,B,D任务互不干扰,同时运行,jobC必须要等任务A,B执行完了才执行,E任务需要任务C,D都执行完才执行,依赖关系</p><p><img src="/images/image/image-20200220192931508.png" alt="image-20200220192931508"></p><blockquote><p>注意:</p><ul><li>文件和yml文件格式类似,但是千万不要用tab,这个不识别\t</li><li>不同的project,需要多次创建project,同一个project,后一次上传的会覆盖掉前一次上传的</li><li>.flow文件的文件名就是project中显示的flow的name</li></ul></blockquote><p>点击job进去,可以对参数进行设置</p><p><img src="/images/image/image-20200220193646623.png" alt="image-20200220193646623"></p>        <h3   id="定时调度" >          <span class="heading-link">定时调度</span>        </h3>      <p>点击Schedule可以设置定时任务的周期,<img src="/images/image/image-20200220194133237.png" alt="image-20200220194133237"></p><p><img src="/images/image/image-20200220194308982.png" alt="image-20200220194308982"></p><p>这样就可在Scheduling下看到定时任务列表,等待下一个时钟来临就会执行</p><p><img src="/images/image/image-20200220194504136.png" alt="image-20200220194504136"></p><p>如果需要移除,可以RemoveSchedule</p>]]></content>
    
    <summary type="html">
    
      工作流调度框架Azkaban的安装和简单使用教程
    
    </summary>
    
    
      <category term="Azkaban" scheme="https://lurongjiang.github.io/categories/Azkaban/"/>
    
    
      <category term="Azkaban" scheme="https://lurongjiang.github.io/tags/Azkaban/"/>
    
  </entry>
  
  <entry>
    <title>Hive的一些坑</title>
    <link href="https://lurongjiang.github.io/2019/04/01/hive%E7%9A%84%E4%B8%80%E4%BA%9B%E5%9D%91/"/>
    <id>https://lurongjiang.github.io/2019/04/01/hive%E7%9A%84%E4%B8%80%E4%BA%9B%E5%9D%91/</id>
    <published>2019-04-01T10:23:05.000Z</published>
    <updated>2019-04-03T07:05:09.000Z</updated>
    
    <content type="html"><![CDATA[        <h1   id="Hive的一些坑" >          <span class="heading-link">Hive的一些坑</span>        </h1>      <ol><li>specified datastore driver(“com.mysql.jdbc.Driver”) was not found</li></ol><p><img src="/images/image/image-20200126114217615.png" alt="image-20200126114217615"></p><p>这个是因为驱动不对,下载了个新的就行了</p><ol start="2"><li>Unable to open a test connection to the given database. JDBC url = jdbc:mysql://hadoop001:3306/test?useSSL=true&amp;serverTimezone=GMT%2B8, username = lrj. Terminating connection pool (set lazyInit to true if you expect to start your database after your app). Original Exception:</li></ol><p><img src="/images/image/image-20200126114500594.png" alt="image-20200126114500594"></p><p>这个需要把ssl禁用了,在jdbcUrl上指定useSSL=false</p><ol start="3"><li>MetaException(message:Version information not found in metastore. )</li></ol><p><img src="/images/image/image-20200126114708126.png" alt="image-20200126114708126"></p><p>这个需要将hive-site.xml中的hive.metastore.schema.verification设置为false</p><ol start="4"><li>Required table missing : “<code>VERSION</code>“ in Catalog “” Schema “”. DataNucleus requires this table to perform its persistence operations. Either your MetaData is incorrect, or you need to enable “datanucleus.autoCreateTables”</li></ol><p><img src="/images/image/image-20200126114930654.png" alt="image-20200126114930654"></p><p>这个需要初始化一下schema,执行</p><p>schematool -dbType mysql -initSchema</p><hr><p>之后就可以启动metastore + hiveserver2服务</p><figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nohup hive --service  metastore &gt; ~/metastore.log 2&gt;&amp;1 &amp;</span><br><span class="line">nohup  hiveserver2  &gt; ~/hiveserver2.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></div></figure><p>测试hiveserver2服务是否ok</p><figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">beeline</span><br></pre></td></tr></table></div></figure><p>打印日志</p><figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">which: no hbase in (&#x2F;usr&#x2F;local&#x2F;bin:&#x2F;usr&#x2F;bin:&#x2F;usr&#x2F;local&#x2F;sbin:&#x2F;usr&#x2F;sbin:&#x2F;mysql&#x2F;bin:&#x2F;home&#x2F;lurongjiang&#x2F;.local&#x2F;bin:&#x2F;home&#x2F;lurongjiang&#x2F;bin:&#x2F;usr&#x2F;software&#x2F;hadoop-2.6.0-cdh5.16.2&#x2F;bin:&#x2F;usr&#x2F;software&#x2F;hadoop-2.6.0-cdh5.16.2&#x2F;sbin:&#x2F;usr&#x2F;software&#x2F;jdk1.8.0_231&#x2F;bin:&#x2F;usr&#x2F;software&#x2F;apache-maven-3.6.3&#x2F;bin:&#x2F;usr&#x2F;software&#x2F;scala-2.11.12&#x2F;bin:&#x2F;usr&#x2F;software&#x2F;hive-1.1.0-cdh5.16.2&#x2F;bin)</span><br><span class="line">Beeline version 1.1.0-cdh5.16.2 by Apache Hive</span><br><span class="line"># 查看下数据库,此时发现没连接</span><br><span class="line">beeline&gt; show databases;</span><br><span class="line">No current connection</span><br><span class="line"># 尝试连接数据库,只需要输入用户名就行,不需要密码</span><br><span class="line">beeline&gt; !connect jdbc:hive2:&#x2F;&#x2F;hadoop001:10000&#x2F;default</span><br><span class="line">Connecting to jdbc:hive2:&#x2F;&#x2F;hadoop001:10000&#x2F;default</span><br><span class="line">Enter username for jdbc:hive2:&#x2F;&#x2F;hadoop001:10000&#x2F;default: lrj</span><br><span class="line">Enter password for jdbc:hive2:&#x2F;&#x2F;hadoop001:10000&#x2F;default: </span><br><span class="line">Error: Failed to open new session: java.lang.RuntimeException: java.lang.RuntimeException: org.apache.hadoop.security.AccessControlException: Permission denied: user&#x3D;lrj, access&#x3D;EXECUTE, inode&#x3D;&quot;&#x2F;tmp&quot;:lurongjiang:supergroup:drwx</span><br></pre></td></tr></table></div></figure><ol start="5"><li>java.lang.RuntimeException: java.lang.RuntimeException: org.apache.hadoop.security.AccessControlException: Permission denied: user=lrj, access=EXECUTE, inode=”/tmp”:lurongjiang:supergroup:drwx——</li></ol><p><img src="/images/image/image-20200126115801228.png" alt="image-20200126115801228"></p><p> 这个是没权限</p><p>hadoop fs -chmod -R 777  /tmp</p><p>再次启动就ok了.</p>]]></content>
    
    <summary type="html">
    
      总结一下在使用hive的时候遇到的一些坑
    
    </summary>
    
    
      <category term="Hive" scheme="https://lurongjiang.github.io/categories/Hive/"/>
    
    
      <category term="Hive" scheme="https://lurongjiang.github.io/tags/Hive/"/>
    
  </entry>
  
  <entry>
    <title>MapReduce教程</title>
    <link href="https://lurongjiang.github.io/2019/04/01/MapReduce%20Tutorial/"/>
    <id>https://lurongjiang.github.io/2019/04/01/MapReduce%20Tutorial/</id>
    <published>2019-04-01T10:23:05.000Z</published>
    <updated>2019-04-03T07:05:09.000Z</updated>
    
    <content type="html"><![CDATA[        <h1   id="MapReduce-Tutorial" >          <span class="heading-link">MapReduce Tutorial</span>        </h1>              <h2   id="Overview" >          <span class="heading-link">Overview</span>        </h2>      <ul><li>Hadoop MapReduce是一个运行在集群上,并行处理大量数据(TB级别)的框架</li><li>MapReduce任务通常讲输入切分成多个独立的块,这些数据块被独立的map任务并行的处理</li><li>该框架会对map输出进行排序,作为reduce任务的输入</li><li>该框架负责调度任务,监视任务并重新执行失败的任务</li><li>通常,计算的节点和数据存储节点是同一个节点,也就是说,MapReduce框架和HDFS都运行在同一些列节点中.这个约束使得框架在数据已经存在的节点上有效地调度任务,从而产生跨集群的非常高的聚合带宽</li><li>MapReduce框架由一个ResourceManager,集群每个节点的NodeManager和每个应用程序的MRAppMaster组成</li><li>必须指定输入输出路径,实现指定的接口或者抽象类,覆写map和reduce方法</li><li>hadoop任务客户端提交任务和相关配置到ResouceManager,ResouceManager负责把任务/配置分发到其他的从节点,并调度和监控任务,给客户端提供任务的状态和诊断信息</li><li>hadoop stream允许用户使用任何可执行的程序来作为mapper/reducer任务</li><li>hadoop pipes工具可以使用C++ API来实现mapper/reducer</li></ul>        <h2   id="Inputs-and-Outputs" >          <span class="heading-link">Inputs and Outputs</span>        </h2>      <ul><li>MapReduce框架只针对&lt;Key,Value&gt;键值对类型操作.也就是说,每个MapReduce任务的输入是&lt;Key,Value&gt;形式,输入也是&lt;Key,Value&gt;形式,输入输出类型可不相同</li><li>Key,Value的类型必须是可以被框架序列化的类型,因此他们必须实现Writable接口.</li><li>Key的类型除了实现Writable接口之外,还需要实现WritableComparable接口,这样才能被排序</li><li>(input) <code>&lt;k1,v1&gt; -&gt;</code> <strong>map</strong> <code>-&gt; &lt;k2,v2&gt; -&gt;</code> <strong>combine</strong> <code>-&gt;  &lt;k2,v2&gt;  -&gt;</code> <strong>reduce</strong> <code>-&gt; &lt;k3,v3&gt;</code>  (output)</li></ul><p><strong>hadoop jar的一些参数</strong></p><ul><li>-files 可以使用逗号分隔,指定多个文件</li><li>-libjars 可以添加jar包到map和reduce类路径下</li><li>-archives 可以使用逗号分隔传入多个压缩包路径</li></ul>        <h2   id="MapReduce-User-Interfaces" >          <span class="heading-link">MapReduce - User Interfaces</span>        </h2>      <ul><li>实现Mapper和Reducer接口吗,并提供map/reduce的实现是任务的核心</li></ul>        <h4   id="Mapper" >          <span class="heading-link">Mapper</span>        </h4>      <ul><li>Mapper将输入的,Key/Value键值对类型映射成中间结果的Key/Value键值对类型</li><li>Maps是独立的任务,负责将输入转成中间结果</li><li>中间结果的类型无需和输入的类型一样</li><li>一个输入可能对应0,1,或者多个输出</li><li>每个InputSplit(由InputFormat产生)都有一个map任务</li><li>可以通过<span class="external-link"><a   href="https://hadoop.apache.org/docs/r2.8.5/api/org/apache/hadoop/mapreduce/Job.html"  target="_blank" rel="noopener">Job.setMapperClass(Class)</a><i class="fa fa-external-link"></i></span> 来传入Mapper的实现.框架将对每个键值对形式的InputSplit调用<span class="external-link"><a   href="https://hadoop.apache.org/docs/r2.8.5/api/org/apache/hadoop/mapreduce/Mapper.html"  target="_blank" rel="noopener">map(WritableComparable, Writable, Context)</a><i class="fa fa-external-link"></i></span> 方法.如果需要清理一些必要资源,可以覆写<code>cleanup(Context)</code>方法</li><li>map的输出可以通过调用context.write(WritableComparable, Writable)来收集</li><li>所有的中间结果会被框架分组,然后传给Reducer.用户使用 <span class="external-link"><a   href="https://hadoop.apache.org/docs/r2.8.5/api/org/apache/hadoop/mapreduce/Job.html"  target="_blank" rel="noopener">Job.setGroupingComparatorClass(Class)</a><i class="fa fa-external-link"></i></span>指定比较器Comparator来控制分组</li><li>Mapper的输出会被排序(sort)和打散(partitioner)分发给每一个Reducer.partitioner数目和reduce任务的数量相同.用户可以实现Partitioner接口来自定义打散规则,控制不同的Key分到对应的reduce任务中</li><li>用户可以使用<span class="external-link"><a   href="https://hadoop.apache.org/docs/r2.8.5/api/org/apache/hadoop/mapreduce/Job.html"  target="_blank" rel="noopener">Job.setCombinerClass(Class)</a><i class="fa fa-external-link"></i></span>对中间输出结果进行本地聚合,这可以减少从Mapper传到Reduce的传输量</li><li>中间结果都是以简单的 (key-len, key, value-len, value) 形式存储,也可通过Configuration设置对中间结果进行压缩</li></ul>        <h5   id="How-Many-Maps" >          <span class="heading-link">How Many Maps?</span>        </h5>      <ul><li>map任务的通常是由输入数据的大小来决定的,也就是输入文件的块数</li><li>对于cpu轻量级任务来说,每个节点map的并行度可达300,但是一般情况下并行度在10-100之间.任务的启动需要一定的时间,所以map任务至少需要1min的执行时间</li></ul>        <h4   id="Reducer" >          <span class="heading-link">Reducer</span>        </h4>      <ul><li>Reducer将相同key的中间结果集进行处理</li><li>reduce任务的个数是通过<span class="external-link"><a   href="https://hadoop.apache.org/docs/r2.8.5/api/org/apache/hadoop/mapreduce/Job.html"  target="_blank" rel="noopener">Job.setNumReduceTasks(int)</a><i class="fa fa-external-link"></i></span>来设置的</li><li>通过 <span class="external-link"><a   href="https://hadoop.apache.org/docs/r2.8.5/api/org/apache/hadoop/mapreduce/Job.html"  target="_blank" rel="noopener">Job.setReducerClass(Class)</a><i class="fa fa-external-link"></i></span>来设置Reducer的实现类.框架对每组&lt;key, (list of values)&gt;的输入进行调用<span class="external-link"><a   href="https://hadoop.apache.org/docs/r2.8.5/api/org/apache/hadoop/mapreduce/Reducer.html"  target="_blank" rel="noopener">reduce(WritableComparable, Iterable, Context)</a><i class="fa fa-external-link"></i></span> 方法进行处理,需要清理资源可以覆写cleanup(Context)</li></ul>        <h5   id="Shuffle" >          <span class="heading-link">Shuffle</span>        </h5>      <ul><li>传到Reducer的输入是经过排序后的mapper的输出.shuffle阶段,框架将通过http获取相关partition的mapper输出</li></ul>        <h5   id="Sort" >          <span class="heading-link">Sort</span>        </h5>      <ul><li>排序阶段,框架将Reducer的输入进行按Key进行分组</li><li>shuffle和sort同时进行.在map输出被拉取时,他们进行合并</li></ul>        <h5   id="Secondary-Sort" >          <span class="heading-link">Secondary Sort</span>        </h5>      <ul><li>如果中间结果key的分组规则需要和进入reducer前的keys的分组规则不一样,那么可以通过<span class="external-link"><a   href="https://hadoop.apache.org/docs/r2.8.5/api/org/apache/hadoop/mapreduce/Job.html"  target="_blank" rel="noopener">Job.setSortComparatorClass(Class)</a><i class="fa fa-external-link"></i></span>来设置比较器.因为<span class="external-link"><a   href="https://hadoop.apache.org/docs/r2.8.5/api/org/apache/hadoop/mapreduce/Job.html"  target="_blank" rel="noopener">Job.setSortComparatorClass(Class)</a><i class="fa fa-external-link"></i></span>时用来控制中间结果的keys是怎么分组的,所以可以用这个来对值进行二次排序</li></ul>        <h5   id="Reduce" >          <span class="heading-link">Reduce</span>        </h5>      <ul><li>reduce阶段,将对每一组&lt;key, (list of values)&gt;输入调用reduce(WritableComparable, Iterable&lt;Writable&gt;, Context)方法</li><li>reduce任务通过 Context.write(WritableComparable, Writable)将输出结果写入文件系统</li><li>输出结果并不会进行排序</li></ul>        <h5   id="How-Many-Reduces" >          <span class="heading-link">How Many Reduces?</span>        </h5>      <ul><li>比较合理的reduce任务的个数计算公式是:0.95(或1.75)×节点数(注意,不是每个节点的最大container数)</li><li>0.95系数可以使得reduce任务在map任务的输出传输结束后同时开始运行</li><li>1.75系数可以使得计算快的节点在一批reduce任务计算结束之后开始计算第二批 reduce任务,实现负载均衡</li><li>增加reduce的数量虽然会增加负载，但是可以改善负载匀衡，降低任务失败带来的负面影响</li><li>放缩系数要比整数略小是因为要给推测性任务和失败任务预留reduce位置</li></ul>        <h5   id="Reducer-NONE" >          <span class="heading-link">Reducer NONE</span>        </h5>      <ul><li>如果不需要reduce任务,将reduce任务个数设置为0是合法的</li><li>这种情况下,map任务的输出会直接写入文件系统的指定输出路径<span class="external-link"><a   href="https://hadoop.apache.org/docs/r2.8.5/api/org/apache/hadoop/mapreduce/lib/output/FileOutputFormat.html"  target="_blank" rel="noopener">FileOutputFormat.setOutputPath(Job, Path)</a><i class="fa fa-external-link"></i></span>.在写入文件系统前,map的输出是进行排序的</li></ul>        <h4   id="Partitioner" >          <span class="heading-link">Partitioner</span>        </h4>      <ul><li>partitioner控制中间map输出的key的分区</li><li>可以按照key(或者key的一部分)来产生分区,默认是使用hash进行分区</li><li>分区数和reduce任务的个数相等</li><li>控制发送给reduce的任务个数</li></ul>        <h4   id="Counter" >          <span class="heading-link">Counter</span>        </h4>      <ul><li>Counter是一个公共基础工具,用来报告MapReduce应用的统计信息</li><li>Mapper和Reducer实现类都可以使用Counter来报告统计</li></ul>        <h3   id="Job-Configuration" >          <span class="heading-link">Job Configuration</span>        </h3>      <ul><li><p>Job就是MapReduce任务的job配置代表</p></li><li><p>一般MapReduce框架会严格按照Job的配置执行,但是有几种情况例外</p><ul><li>某些配置参数被标记为final类型,所以是修改配置是没法达到目的的,例如1.1比例</li><li>某些配置虽然可以直接配置,但是还需要配合其他的参数一起配置才能生效</li></ul></li><li><p>Job通常会指定Mapper,combiner(有必要的话),Partitioner,Reducer,InputFormat,OutputFormat的实现类</p></li><li><p>输入可以使用下列方式指定输入数据文件集</p><ul><li>(<span class="external-link"><a   href="https://hadoop.apache.org/docs/r2.8.5/api/org/apache/hadoop/mapreduce/lib/input/FileInputFormat.html"  target="_blank" rel="noopener">FileInputFormat.setInputPaths(Job, Path…)</a><i class="fa fa-external-link"></i></span>/ <span class="external-link"><a   href="https://hadoop.apache.org/docs/r2.8.5/api/org/apache/hadoop/mapreduce/lib/input/FileInputFormat.html"  target="_blank" rel="noopener">FileInputFormat.addInputPath(Job, Path)</a><i class="fa fa-external-link"></i></span>)</li><li>(<span class="external-link"><a   href="https://hadoop.apache.org/docs/r2.8.5/api/org/apache/hadoop/mapreduce/lib/input/FileInputFormat.html"  target="_blank" rel="noopener">FileInputFormat.setInputPaths(Job, String…)</a><i class="fa fa-external-link"></i></span>/ <span class="external-link"><a   href="https://hadoop.apache.org/docs/r2.8.5/api/org/apache/hadoop/mapreduce/lib/input/FileInputFormat.html"  target="_blank" rel="noopener">FileInputFormat.addInputPaths(Job, String)</a><i class="fa fa-external-link"></i></span></li></ul></li><li><p>输出可以使用(<span class="external-link"><a   href="https://hadoop.apache.org/docs/r2.8.5/api/org/apache/hadoop/mapreduce/lib/output/FileOutputFormat.html"  target="_blank" rel="noopener">FileOutputFormat.setOutputPath(Path)</a><i class="fa fa-external-link"></i></span>)来指定输出文件集</p></li><li><p>其他配置都是可选的,如Caparator的使用,将文件放置到DistributeCache,是否中间结果或者最终输出结果需要压缩,是否允许推测模式,最大任务重试次数等</p></li><li><p>可以通过<span class="external-link"><a   href="https://hadoop.apache.org/docs/r2.8.5/api/org/apache/hadoop/conf/Configuration.html"  target="_blank" rel="noopener">Configuration.set(String, String)</a><i class="fa fa-external-link"></i></span>/ <span class="external-link"><a   href="https://hadoop.apache.org/docs/r2.8.5/api/org/apache/hadoop/conf/Configuration.html"  target="_blank" rel="noopener">Configuration.get(String)</a><i class="fa fa-external-link"></i></span>来设置和获取任意需要的参数.但是对于大的只读数据集,还是要用DistributedCache</p></li></ul>        <h3   id="Task-Execution-amp-Environment" >          <span class="heading-link">Task Execution &amp; Environment</span>        </h3>      <ul><li>MRAppMaster在独立的JVM中执行每个Mapper/Reducer任务(任务进程级别)</li><li>子任务继承了MRAppMaster的环境.</li><li>用户可以通过 <code>mapreduce.{map|reduce}.java.opts</code> 给子任务添加额外的参数</li><li>运行时非标准类库路径可以通过-Djava.library.path=&lt;&gt;指定</li><li>如果mapreduce.{map|reduce}.java.opts参数配置包含了<em>@taskid@</em>则在运行时被替换成taskId</li><li>显示JVM GC,JVM JMX无密代理(这样可以结合jconsole,查看内存,线程,线程垃圾回收),最大堆内存,添加其他路径到任务java.library.path的例子</li></ul><figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>mapreduce.map.java.opts<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span></span><br><span class="line">  -Xmx512M -Djava.library.path=/home/mycompany/lib -verbose:gc -Xloggc:/tmp/@taskid@.gc</span><br><span class="line">  -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false</span><br><span class="line">  <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>mapreduce.reduce.java.opts<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span></span><br><span class="line">  -Xmx1024M -Djava.library.path=/home/mycompany/lib -verbose:gc -Xloggc:/tmp/@taskid@.gc</span><br><span class="line">  -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false</span><br><span class="line">  <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></div></figure>        <h4   id="Memory-Management" >          <span class="heading-link">Memory Management</span>        </h4>      <ul><li><p>用户可以通过<code>mapreduce.{map|reduce}.memory.mb</code>指定子任务的最大虚拟内存.注意这个设置是进程级别的</p></li><li><p>注意这个参数不要大于-Xmx的参数,否则VM可能会无法启动</p></li><li><p><code>mapreduce.{map|reduce}.java.opt</code>只能配置MRAppMaster的子任务.配置守护线程的需要参考 <span class="external-link"><a   href="https://hadoop.apache.org/docs/r2.8.5/hadoop-project-dist/hadoop-common/ClusterSetup.html#Configuring_Environment_of_Hadoop_Daemons"  target="_blank" rel="noopener">Configuring the Environment of the Hadoop Daemons</a><i class="fa fa-external-link"></i></span></p></li><li><p>map/reduce任务的性能,可能会被并发数,写入磁盘的频率影响.检查文件系统的统计报告,尤其是从map进入reduce的字节数,这参数是非常宝贵的.</p></li></ul>        <h4   id="Map-Parameters" >          <span class="heading-link">Map Parameters</span>        </h4>      <ul><li>map输出的记录会被序列化到缓冲区,元数据存储在统计缓冲区</li><li>当缓冲区或者元数据超过一定的阈值,缓冲区的内容会被排序然后存储和写入磁盘</li><li>如果缓冲区一直是满状态的,map线程将被阻塞</li><li>map结束后,没有写入磁盘的map输出记录继续写入.</li><li>磁盘上所有的map输出文件段会合并成单个文件</li><li>减少写入磁盘的次数,可以减少map的次数,但是加大缓存区会压缩mapper的可用内存</li></ul><div class="table-container"><table><thead><tr><th align="left">Name</th><th align="left">Type</th><th align="left">Description</th></tr></thead><tbody><tr><td align="left">mapreduce.task.io.sort.mb</td><td align="left">int</td><td align="left">序列化和map输出到缓冲区的记录预排序的累计大小,单位为MB</td></tr><tr><td align="left">mapreduce.map.sort.spill.percent</td><td align="left">float</td><td align="left">序列化缓冲区spill阈值比例,超过会将缓冲区内容写入磁盘</td></tr></tbody></table></div><ul><li>spill之后,如果在写入磁盘过程中,map的输出没有超过spill阈值,则会继续收集到spill结束</li><li>如果是spill设置为0.33,在spill到磁盘的过程,缓冲区继续会被map的输出填充,下一次spill的时候再将这期间填充的内容写到磁盘</li><li>如果spill设置为0.66,则不会触发下一次spill.也就是说,spill可以触发,但是不会阻塞</li><li>一条记录大于缓冲区的会先触发spill,而且会被spill到一个单独的文件.无论这条记录有没有定义combiner,它都会被combiner传输</li></ul>        <h4   id="Shuffle-Reduce-Parameters" >          <span class="heading-link">Shuffle/Reduce Parameters</span>        </h4>      <ul><li>reduce将partitioner通过http指派给自己的map输出加载到内存,并定期合并输出到磁盘.</li><li>如果中间结果是压缩输出,那么输出也是被reduce压缩的读进内存中,减少了内存的压力</li></ul><div class="table-container"><table><thead><tr><th align="left">Name</th><th align="left">Type</th><th align="left">Description</th></tr></thead><tbody><tr><td align="left">mapreduce.task.io.soft.factor</td><td align="left">int</td><td align="left">每次合并磁盘上段的数目.如果超过这个设置会分多次进行合并</td></tr><tr><td align="left">mapreduce.reduce.merge.inmem.thresholds</td><td align="left">int</td><td align="left">在合并写入磁盘之前,将排序后的map输出加载到内存的map输出数目.这个值通常设置很大(1000)或者直接禁用(0),因为内存合并要比磁盘合并的代价小得多.这个阈值只影响shuffle期间内存中合并的频率</td></tr><tr><td align="left">mapreduce.reduce.shuffle.merge.percent</td><td align="left">float</td><td align="left">在内存合并之前,读取map输出的内存阈值,代表着用于存储map输出在内存中的百分比.因为map的输出并不适合存储在内存,所以设置很高会知道使得获取和合并的并行度下降.相反,设置为1可以使得内存运行的reduce更快.这个参数只影响shuffle期间的内存内合并频率</td></tr><tr><td align="left">mapreduce.reduce.shuffle.input.buffer.percent</td><td align="left">float</td><td align="left">在shuffle期间,可以分配来存储map输出的内存百分比,相对于<code>mapreduce.reduce.java.opts</code>指定的最大堆内存.把这个值设的大一点可以存储更多的map输出,但是也应该为框架预留一些内存</td></tr><tr><td align="left">mapreduce.reduce.input.buffer.percent</td><td align="left">float</td><td align="left">相当于reduce阶段,用于存储map输出的最大堆内存的内存百分比.reduce开始的时候,map的输出被合并到磁盘,知道map输出在一定的阈值之内.默认情况下,在reduce开始之前,map的输出都会被合并到磁盘,这样才能使得reduce充分的利用到内存.对于只要内存密集型的reduce任务,应该增加这个值,减少磁盘的的往返时间</td></tr></tbody></table></div>        <h4   id="Configured-Parameters" >          <span class="heading-link">Configured Parameters</span>        </h4>      <p>这些参数都是局部的,每个任务的</p><div class="table-container"><table><thead><tr><th align="left">Name</th><th align="left">Type</th><th align="left">Description</th></tr></thead><tbody><tr><td align="left">mapreduce.job.id</td><td align="left">String</td><td align="left">The job id</td></tr><tr><td align="left">mapreduce.job.jar</td><td align="left">String</td><td align="left">job.jar location in job directory</td></tr><tr><td align="left">mapreduce.job.local.dir</td><td align="left">String</td><td align="left">The job specific shared scratch space</td></tr><tr><td align="left">mapreduce.task.id</td><td align="left">String</td><td align="left">The task id</td></tr><tr><td align="left">mapreduce.task.attempt.id</td><td align="left">String</td><td align="left">The task attempt id</td></tr><tr><td align="left">mapreduce.task.is.map</td><td align="left">boolean</td><td align="left">Is this a map task</td></tr><tr><td align="left">mapreduce.task.partition</td><td align="left">int</td><td align="left">The id of the task within the job</td></tr><tr><td align="left">mapreduce.map.input.file</td><td align="left">String</td><td align="left">The filename that the map is reading from</td></tr><tr><td align="left">mapreduce.map.input.start</td><td align="left">long</td><td align="left">The offset of the start of the map input split</td></tr><tr><td align="left">mapreduce.map.input.length</td><td align="left">long</td><td align="left">The number of bytes in the map input split</td></tr><tr><td align="left">mapreduce.task.output.dir</td><td align="left">String</td><td align="left">The task’s temporary output directory</td></tr></tbody></table></div><p>在流任务执行过程中,这些参数会被转化.点(.)会被转成下划线(_),所以要想在流任务的mapper/reducer中获得这些值,需要使用下划线形式.</p>        <h4   id="Distributing-Libraries" >          <span class="heading-link">Distributing Libraries</span>        </h4>      <ul><li><span class="external-link"><a   href="https://hadoop.apache.org/docs/r2.8.5/hadoop-mapreduce-client/hadoop-mapreduce-client-core/MapReduceTutorial.html#DistributedCache"  target="_blank" rel="noopener">DistributedCache</a><i class="fa fa-external-link"></i></span>分布式缓存可以分发jars和本地类库给map/reduce任务使用.</li><li>child-jvm总将自己的工作目录添加到java.library.path和LD_LIBRARY_PATH</li><li>缓存中的类库可以通过System.loadLibrary或者System.load</li></ul>        <h3   id="Job-Submission-and-Monitoring" >          <span class="heading-link">Job Submission and Monitoring</span>        </h3>      <ul><li>Job是用户任务和ResourceManager交互的主要接口</li><li>Job的提交流程包括<ul><li>检查输入输出路径</li><li>计算任务的InputSplit</li><li>有必要的话,设置必要的分布式缓存</li><li>拷贝任务的jar和配置到MapReduce系统目录</li><li>提交任务到ResourceManager.监控任务状态是可选的</li><li>任务的执行记录历史存放在 <code>mapreduce.jobhistory.intermediate-done-dir</code> 和<code>mapreduce.jobhistory.done-dir</code></li></ul></li></ul>        <h4   id="Job-Control" >          <span class="heading-link">Job Control</span>        </h4>      <ul><li>对于单个MapReduce任务无法完成的任务,用户可能需要执行MapReduce任务链,才能完成.这还是非常容易的,因为任务的输出一般是存储在分布式文件系统中,所以一个任务的输出可以作为另一个任务的输入.这也就使得判断任务是否完成,不管成功或者失败,都需要用户来控制.主要有两种控制手段<ul><li>Job.submit() 提交任务到集群中,立即返回</li><li>Job.waitForCompletion(boolean) 提交任务到集群中,等待其完成</li></ul></li></ul>        <h3   id="Job-Input" >          <span class="heading-link">Job Input</span>        </h3>      <ul><li><p>InputFormat描述了MapReduce任务的输入规范</p></li><li><p>InputFormat的职责是:</p><ul><li>校验输入是否合法</li><li>将输入逻辑切分成InputSplit实例,之后将它们发送到独立的Mapper</li><li>RecordReader 实现了从符合框架逻辑的InputSplit实例收集输入的记录,提供给Mapper进行处理</li></ul></li><li><p>默认的InputFormat是基于输入文件的总字节大小,将输入文件切分成逻辑的InputSplit实例,例如FileInputFormat的子类.然而,文件系统的blocksize只是split的上限,下限需要通过<code>mapreduce.input.fileinputformat.split.minsize</code>来设置</p></li><li><p>压缩文件并不一定可以被切分,如.gz文件会把完整的文件交给一个mapper来处理</p></li></ul>        <h4   id="InputSplit" >          <span class="heading-link">InputSplit</span>        </h4>      <ul><li><p>InputSplit代表了一个独立Mapper处理的输入数据</p></li><li><p>通常InputSplit是面向字节的,把面向字节转为面向记录是RecordReader的职责</p></li><li><p>FileSplit是默认的InputSplit实现,它把输入设置成mapreduce.map.input.file 属性,用于进行逻辑分割</p></li></ul>        <h4   id="RecordReader" >          <span class="heading-link">RecordReader</span>        </h4>      <ul><li>RecordReader负责将InputSplit的面向字节的输入转换成面向记录,提供给Mapper实现去处理每一条记录.因此RecordReader承担了从记录中提取出键值对的任务</li></ul>        <h3   id="Job-Output" >          <span class="heading-link">Job Output</span>        </h3>      <ul><li>OutputFormat描述了MapReduce输出的规范</li><li>OutputFormat的职责:<ul><li>校验任务的输出,例如输出目录是否存在</li><li>RecordWriter实现可以将任务的输出写入到文件,存储在文件系统中</li></ul></li><li>TextOutputFormat是默认的OutputFormat实现</li></ul>]]></content>
    
    <summary type="html">
    
      MapReduce官网教程文档翻译
    
    </summary>
    
    
      <category term="Hadoop" scheme="https://lurongjiang.github.io/categories/Hadoop/"/>
    
      <category term="MapReduce" scheme="https://lurongjiang.github.io/categories/Hadoop/MapReduce/"/>
    
    
      <category term="Hadoop,MapReduce" scheme="https://lurongjiang.github.io/tags/Hadoop-MapReduce/"/>
    
  </entry>
  
  <entry>
    <title>Hive UDF</title>
    <link href="https://lurongjiang.github.io/2019/03/15/Hive%20UDF/"/>
    <id>https://lurongjiang.github.io/2019/03/15/Hive%20UDF/</id>
    <published>2019-03-15T03:19:04.000Z</published>
    <updated>2019-03-15T07:23:24.000Z</updated>
    
    <content type="html"><![CDATA[        <h1   id="Hive-UDF" >          <span class="heading-link">Hive UDF</span>        </h1>      <p>hive内置函数并不一定满足我们的业务要求,所以需要拓展,即用户自定义函数</p><p><strong>UDF</strong></p><p>User Defined Function</p><ul><li>UDF (one-to-one)</li><li>UDAF(many-to-one)</li><li>UDTF(one-to-many)</li></ul>        <h2   id="创建UDF步骤" >          <span class="heading-link">创建UDF步骤</span>        </h2>      <ul><li><p>添加依赖</p><figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hive<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hive-exec<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;hive.cdh.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></div></figure></li></ul><ul><li>创建自定义类,继承UDF</li></ul>]]></content>
    
    <summary type="html">
    
      Hive UDF的介绍和基本使用
    
    </summary>
    
    
      <category term="Hive" scheme="https://lurongjiang.github.io/categories/Hive/"/>
    
    
      <category term="hive" scheme="https://lurongjiang.github.io/tags/hive/"/>
    
      <category term="udf" scheme="https://lurongjiang.github.io/tags/udf/"/>
    
      <category term="user-defined-function" scheme="https://lurongjiang.github.io/tags/user-defined-function/"/>
    
  </entry>
  
  <entry>
    <title>Hadoop MapReduce编程核心</title>
    <link href="https://lurongjiang.github.io/2019/03/12/Hadoop%20MapReduce%E7%BC%96%E7%A8%8B%E6%A0%B8%E5%BF%83/"/>
    <id>https://lurongjiang.github.io/2019/03/12/Hadoop%20MapReduce%E7%BC%96%E7%A8%8B%E6%A0%B8%E5%BF%83/</id>
    <published>2019-03-12T07:14:04.000Z</published>
    <updated>2019-03-15T13:01:05.000Z</updated>
    
    <content type="html"><![CDATA[        <h1   id="Hadoop-MapReduce编程核心" >          <span class="heading-link">Hadoop MapReduce编程核心</span>        </h1>              <h2   id="Partitioner-分区" >          <span class="heading-link">Partitioner 分区</span>        </h2>      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * Partitions the key space.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * &lt;p&gt;&lt;code&gt;Partitioner&lt;/code&gt; controls the partitioning of the keys of the </span></span><br><span class="line"><span class="comment"> * intermediate map-outputs. The key (or a subset of the key) is used to derive</span></span><br><span class="line"><span class="comment"> * the partition, typically by a hash function. The total number of partitions</span></span><br><span class="line"><span class="comment"> * is the same as the number of reduce tasks for the job. Hence this controls</span></span><br><span class="line"><span class="comment"> * which of the &lt;code&gt;m&lt;/code&gt; reduce tasks the intermediate key (and hence the </span></span><br><span class="line"><span class="comment"> * record) is sent for reduction.&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * partitioner是控制中间map阶段输出结果的key的分区.key通常被hash,分发到各个分区</span></span><br><span class="line"><span class="comment"> * 分区数一般和reduce job的个数相等,</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> Reducer</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@InterfaceAudience</span>.Public</span><br><span class="line"><span class="meta">@InterfaceStability</span>.Stable</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Partitioner</span>&lt;<span class="title">K2</span>, <span class="title">V2</span>&gt; <span class="keyword">extends</span> <span class="title">JobConfigurable</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/** </span></span><br><span class="line"><span class="comment">   * Get the paritition number for a given key (hence record) given the total </span></span><br><span class="line"><span class="comment">   * number of partitions i.e. number of reduce-tasks for the job.</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * &lt;p&gt;Typically a hash function on a all or a subset of the key.&lt;/p&gt;</span></span><br><span class="line"><span class="comment">   * 根据分区总数,例如reduce job个数,获取分区的编号.一般是对所有key或者key的一部分进行进行hash处理</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> key the key to be paritioned.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> value the entry value.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> numPartitions the total number of partitions.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> the partition number for the &lt;code&gt;key&lt;/code&gt;.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">int</span> <span class="title">getPartition</span><span class="params">(K2 key, V2 value, <span class="keyword">int</span> numPartitions)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* hash分区的实现就是key取hashCode和reduce个数进行取模</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HashPartitioner</span>&lt;<span class="title">K2</span>, <span class="title">V2</span>&gt; <span class="keyword">implements</span> <span class="title">Partitioner</span>&lt;<span class="title">K2</span>, <span class="title">V2</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(JobConf job)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Use &#123;<span class="doctag">@link</span> Object#hashCode()&#125; to partition. */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPartition</span><span class="params">(K2 key, V2 value,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="keyword">int</span> numReduceTasks)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (key.hashCode() &amp; Integer.MAX_VALUE) % numReduceTasks;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure><blockquote><p> <strong>需要注意的是</strong></p><ul><li>分区数一般和reduce job个数相等</li><li>如果分区数&lt;reduce job个数,将导致输出有很多无用的空文件</li><li>如果分区数&gt;reduce job个数,将导致有些map输出找不到hash路径,出现java.io.IOException: Illegal partition for xxx的异常</li></ul></blockquote>        <h2   id="Combiner-局部汇总" >          <span class="heading-link">Combiner 局部汇总</span>        </h2>      <p>Combiner是hadoop对map阶段输出结果进行本地局部聚合,提高后面reduce的效率,避免大量数据进行网络传输.</p><blockquote><p><strong>需要注意的是</strong></p><ul><li>并非所有的任务都适用于Combiner</li><li>求和等操作,局部聚合可以有效的提高后面reduce的效率</li><li>平均值等操作,这种并不适用,因为局部平均值和全局平均值还是有差异的</li></ul></blockquote>]]></content>
    
    <summary type="html">
    
      Hadoop MapReduce编程核心相关介绍
    
    </summary>
    
    
      <category term="Hadoop" scheme="https://lurongjiang.github.io/categories/Hadoop/"/>
    
    
      <category term="hadoop" scheme="https://lurongjiang.github.io/tags/hadoop/"/>
    
      <category term="MapReduce" scheme="https://lurongjiang.github.io/tags/MapReduce/"/>
    
  </entry>
  
  <entry>
    <title>Hello World</title>
    <link href="https://lurongjiang.github.io/2018/07/18/hello-world/"/>
    <id>https://lurongjiang.github.io/2018/07/18/hello-world/</id>
    <published>2018-07-18T01:35:45.000Z</published>
    <updated>2018-07-19T15:45:14.000Z</updated>
    
    <content type="html"><![CDATA[<p>Welcome to <span class="external-link"><a   href="https://hexo.io/"  target="_blank" rel="noopener">Hexo</a><i class="fa fa-external-link"></i></span>! This is your very first post. Check <span class="external-link"><a   href="https://hexo.io/docs/"  target="_blank" rel="noopener">documentation</a><i class="fa fa-external-link"></i></span> for more info. If you get any problems when using Hexo, you can find the answer in <span class="external-link"><a   href="https://hexo.io/docs/troubleshooting.html"  target="_blank" rel="noopener">troubleshooting</a><i class="fa fa-external-link"></i></span> or you can ask me on <span class="external-link"><a   href="https://github.com/hexojs/hexo/issues"  target="_blank" rel="noopener">GitHub</a><i class="fa fa-external-link"></i></span>.</p>        <h2   id="Quick-Start" >          <span class="heading-link">Quick Start</span>        </h2>              <h3   id="Create-a-new-post" >          <span class="heading-link">Create a new post</span>        </h3>      <figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></div></figure><p>More info: <span class="external-link"><a   href="https://hexo.io/docs/writing.html"  target="_blank" rel="noopener">Writing</a><i class="fa fa-external-link"></i></span></p>        <h3   id="Run-server" >          <span class="heading-link">Run server</span>        </h3>      <figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></div></figure><p>More info: <span class="external-link"><a   href="https://hexo.io/docs/server.html"  target="_blank" rel="noopener">Server</a><i class="fa fa-external-link"></i></span></p>        <h3   id="Generate-static-files" >          <span class="heading-link">Generate static files</span>        </h3>      <figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></div></figure><p>More info: <span class="external-link"><a   href="https://hexo.io/docs/generating.html"  target="_blank" rel="noopener">Generating</a><i class="fa fa-external-link"></i></span></p>        <h3   id="Deploy-to-remote-sites" >          <span class="heading-link">Deploy to remote sites</span>        </h3>      <figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></div></figure><p>More info: <span class="external-link"><a   href="https://hexo.io/docs/one-command-deployment.html"  target="_blank" rel="noopener">Deployment</a><i class="fa fa-external-link"></i></span></p>]]></content>
    
    <summary type="html">
    
      这是一段文章摘要，是通过 Front-Matter 的 excerpt 属性设置的。
    
    </summary>
    
    
      <category term="TestNest" scheme="https://lurongjiang.github.io/categories/TestNest/"/>
    
      <category term="test1" scheme="https://lurongjiang.github.io/categories/test1/"/>
    
      <category term="nest1" scheme="https://lurongjiang.github.io/categories/TestNest/nest1/"/>
    
      <category term="nest2" scheme="https://lurongjiang.github.io/categories/TestNest/nest2/"/>
    
    
      <category term="PlayStation" scheme="https://lurongjiang.github.io/tags/PlayStation/"/>
    
      <category term="Games" scheme="https://lurongjiang.github.io/tags/Games/"/>
    
  </entry>
  
</feed>
