<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="keywords" content="LRJ, Blog"><meta name="description" content="个人博客,记录成长历程"><title>SpringSecurity获取Token源码</title><link rel="icon" href="/images/icons/favicon-16x16.png?v=1.7.0" type="image/png" sizes="16x16"><link rel="icon" href="/images/icons/favicon-32x32.png?v=1.7.0" type="image/png" sizes="32x32"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=1.7.0"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  fontawesome: {"prefix":"fa"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":true,"scrollDownIcon":false},
  post_widget: {"end_text":true},
  night_mode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"default","highlight":"ocean","word_wrap":false},
  reward: false,
  fancybox: false,
  zoom_image: {"enable":true,"mask_color":"rgba(0,0,0,0.6)"},
  gallery_waterfall: undefined,
  lazyload: undefined,
  pjax: undefined,
  external_link: {"icon":{"enable":true,"name":"external-link"}},
  shortcuts: undefined,
  prompt: {"copy_success":"Copy Success","copy_error":"Copy Error","creative_commons":"Creative Commons","copy_button":"Copy"}
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="Blog" type="application/atom+xml">
</head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-btn fa fa-bars"></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__a" href="/"><i class="fa fa-home"></i>Home</a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__a" href="/archives/"><i class="fa fa-folder-open"></i>Archives</a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__a" href="/categories/"><i class="fa fa-th"></i>Categories</a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__a" href="/tags/"><i class="fa fa-tags"></i>Tags</a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__a" href="/about/"><i class="fa fa-user"></i>About</a></div></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-info"><div class="header-info-inner"><div class="header-info-title">Blog</div><div class="header-info-subtitle">个人博客,记录成长历程</div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content"><div id="is-post"></div><div class="post"><header class="post-header"><h1 class="post-header-title">SpringSecurity获取Token源码</h1><div class="post-header-meta"><span class="post-header-meta-create"><i class="fa fa-calendar-o"></i><span>Posted </span><span>2020-02-20</span></span><span class="post-header-meta-update"><i class="fa fa-calendar-check-o"></i><span>updated </span><span>2020-02-25</span></span></div></header><div class="post-body">
        <h1   id="SpringSecurity-创建AccessToken" >
          <span class="heading-link">SpringSecurity-创建AccessToken</span>
        </h1>
      <p><img src="/images/imageimage-20200320174700329.png" alt="image-20200320174700329"></p>
<ul>
<li>TokenEndPoint 就是判断grant_type到底是什么模式</li>
<li>ClientDetailService 判断client_id</li>
<li>ClientDetails封装请求的client的信息</li>
<li>TokenRequest将ClientDetails封装到请求里,因为Client信息也是token的一部分</li>
<li>TokenRequest请求TokenGranter(CompositeTokenGranter,默认),TokenGranter封装了四种授权模式,挑一个模式实现来生成token逻辑</li>
<li>Oauth2Request包含了client信息的ToekenRequests</li>
<li>Authentication包含了当前认证的用户信息,通过UserDetailsService出来的UserDetails</li>
<li>Oauth2Authentication包含了当前是哪个第三方client_id请求哪个用户授权,授权模式是什么,授权的参数是什么</li>
<li>AuthorizationServerTokenServices(默认实现DefaultTokenService)<ul>
<li>TokenStore 令牌的存取关联</li>
<li>TokenEnhancer 令牌的增强体,令牌生成后,可以加一些东西</li>
</ul>
</li>
</ul>

        <h2   id="创建Token的源码跟踪" >
          <span class="heading-link">创建Token的源码跟踪</span>
        </h2>
      
        <h3   id="TokenEndPoint" >
          <span class="heading-link">TokenEndPoint</span>
        </h3>
      <p>申请token入口</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/oauth/token"</span>, method=RequestMethod.POST)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ResponseEntity&lt;OAuth2AccessToken&gt; <span class="title">postAccessToken</span><span class="params">(Principal principal, @RequestParam</span></span></span><br><span class="line"><span class="function"><span class="params">Map&lt;String, String&gt; parameters)</span> <span class="keyword">throws</span> HttpRequestMethodNotSupportedException </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!(principal <span class="keyword">instanceof</span> Authentication)) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> InsufficientAuthenticationException(</span><br><span class="line">				<span class="string">"There is no client authentication. Try adding an appropriate authentication filter."</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//从请求令牌中获取client_id</span></span><br><span class="line">	String clientId = getClientId(principal);</span><br><span class="line">    <span class="comment">//调用ClientDetailsService查询第三方应用的详细信息</span></span><br><span class="line">	ClientDetails authenticatedClient = getClientDetailsService().loadClientByClientId(clientId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//使用第三方应用的信息创建TokenRequest</span></span><br><span class="line">	TokenRequest tokenRequest = getOAuth2RequestFactory().createTokenRequest(parameters, authenticatedClient);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (clientId != <span class="keyword">null</span> &amp;&amp; !clientId.equals(<span class="string">""</span>)) &#123;</span><br><span class="line">		<span class="comment">// Only validate the client details if a client authenticated during this</span></span><br><span class="line">		<span class="comment">// request.</span></span><br><span class="line">		<span class="keyword">if</span> (!clientId.equals(tokenRequest.getClientId())) &#123;</span><br><span class="line">			<span class="comment">// double check to make sure that the client ID in the token request is the same as that in the</span></span><br><span class="line">			<span class="comment">// authenticated client</span></span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> InvalidClientException(<span class="string">"Given client ID does not match authenticated client"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (authenticatedClient != <span class="keyword">null</span>) &#123;</span><br><span class="line">		oAuth2RequestValidator.validateScope(tokenRequest, authenticatedClient);</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">//必须带grant_type</span></span><br><span class="line">	<span class="keyword">if</span> (!StringUtils.hasText(tokenRequest.getGrantType())) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> InvalidRequestException(<span class="string">"Missing grant type"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">//如果是简化模式,不会有grant_type,第一次就发放令牌</span></span><br><span class="line">	<span class="keyword">if</span> (tokenRequest.getGrantType().equals(<span class="string">"implicit"</span>)) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> InvalidGrantException(<span class="string">"Implicit grant type not supported from token endpoint"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果是授权码模式请求,先将token请求的scope置空</span></span><br><span class="line">    <span class="comment">//因为此时只是请求授权码,即使你设置了all,但你也不一定有all的权限</span></span><br><span class="line">    <span class="comment">//用户的实际scope是在用户授权之后才能决定</span></span><br><span class="line">	<span class="keyword">if</span> (isAuthCodeRequest(parameters)) &#123;</span><br><span class="line">		<span class="comment">// The scope was requested or determined during the authorization step</span></span><br><span class="line">		<span class="keyword">if</span> (!tokenRequest.getScope().isEmpty()) &#123;</span><br><span class="line">			logger.debug(<span class="string">"Clearing scope of incoming token request"</span>);</span><br><span class="line">			tokenRequest.setScope(Collections.&lt;String&gt; emptySet());</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果是刷新令牌,令牌有自己的scope,所以重新设置scope</span></span><br><span class="line">	<span class="keyword">if</span> (isRefreshTokenRequest(parameters)) &#123;</span><br><span class="line">		<span class="comment">// A refresh token has its own default scopes, so we should ignore any added by the factory here.</span></span><br><span class="line">		tokenRequest.setScope(OAuth2Utils.parseParameterList(parameters.get(OAuth2Utils.SCOPE)));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//生成token</span></span><br><span class="line">	OAuth2AccessToken token = getTokenGranter().grant(tokenRequest.getGrantType(), tokenRequest);</span><br><span class="line">	<span class="keyword">if</span> (token == <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedGrantTypeException(<span class="string">"Unsupported grant type: "</span> + tokenRequest.getGrantType());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//返回token</span></span><br><span class="line">	<span class="keyword">return</span> getResponse(token);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h3   id="TokenRequest" >
          <span class="heading-link">TokenRequest</span>
        </h3>
      <p>封装Client信息成TokenRequest的逻辑</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> TokenRequest <span class="title">createTokenRequest</span><span class="params">(Map&lt;String, String&gt; requestParameters, ClientDetails authenticatedClient)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//从请求中获取client_id参数</span></span><br><span class="line">	String clientId = requestParameters.get(OAuth2Utils.CLIENT_ID);</span><br><span class="line">	<span class="keyword">if</span> (clientId == <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="comment">// if the clientId wasn't passed in in the map, we add pull it from the authenticated client object</span></span><br><span class="line">		clientId = authenticatedClient.getClientId();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//如果两个client_id不匹配,抛异常</span></span><br><span class="line">		<span class="comment">// otherwise, make sure that they match</span></span><br><span class="line">		<span class="keyword">if</span> (!clientId.equals(authenticatedClient.getClientId())) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> InvalidClientException(<span class="string">"Given client ID does not match authenticated client"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">//获取grant_type</span></span><br><span class="line">	String grantType = requestParameters.get(OAuth2Utils.GRANT_TYPE);</span><br><span class="line">    <span class="comment">//获取scope</span></span><br><span class="line">	Set&lt;String&gt; scopes = extractScopes(requestParameters, clientId);</span><br><span class="line">	TokenRequest tokenRequest = <span class="keyword">new</span> TokenRequest(requestParameters, clientId, scopes, grantType);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> tokenRequest;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//查寻client的scope</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Set&lt;String&gt; <span class="title">extractScopes</span><span class="params">(Map&lt;String, String&gt; requestParameters, String clientId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//从参数中获取scope</span></span><br><span class="line">	Set&lt;String&gt; scopes = OAuth2Utils.parseParameterList(requestParameters.get(OAuth2Utils.SCOPE));</span><br><span class="line">    <span class="comment">//调用clientDetailsService获取client信息</span></span><br><span class="line">	ClientDetails clientDetails = clientDetailsService.loadClientByClientId(clientId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果参数没带,直接把数据库的scope设置一下</span></span><br><span class="line">	<span class="keyword">if</span> ((scopes == <span class="keyword">null</span> || scopes.isEmpty())) &#123;</span><br><span class="line">		<span class="comment">// If no scopes are specified in the incoming data, use the default values registered with the client</span></span><br><span class="line">		<span class="comment">// (the spec allows us to choose between this option and rejecting the request completely, so we'll take the</span></span><br><span class="line">		<span class="comment">// least obnoxious choice as a default).</span></span><br><span class="line">		scopes = clientDetails.getScope();</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">//检查scope</span></span><br><span class="line">	<span class="keyword">if</span> (checkUserScopes) &#123;</span><br><span class="line">		scopes = checkUserScopes(scopes, clientDetails);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> scopes;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Set&lt;String&gt; <span class="title">checkUserScopes</span><span class="params">(Set&lt;String&gt; scopes, ClientDetails clientDetails)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!securityContextAccessor.isUser()) &#123;</span><br><span class="line">		<span class="keyword">return</span> scopes;</span><br><span class="line">	&#125;</span><br><span class="line">	Set&lt;String&gt; result = <span class="keyword">new</span> LinkedHashSet&lt;String&gt;();</span><br><span class="line">	Set&lt;String&gt; authorities = AuthorityUtils.authorityListToSet(securityContextAccessor.getAuthorities());</span><br><span class="line">    <span class="comment">//如果用户具有这些scope的权限或者角色,添加到scope</span></span><br><span class="line">	<span class="keyword">for</span> (String scope : scopes) &#123;</span><br><span class="line">		<span class="keyword">if</span> (authorities.contains(scope) || authorities.contains(scope.toUpperCase())</span><br><span class="line">				|| authorities.contains(<span class="string">"ROLE_"</span> + scope.toUpperCase())) &#123;</span><br><span class="line">			result.add(scope);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h3   id="TokenGranter" >
          <span class="heading-link">TokenGranter</span>
        </h3>
      <p>根据4种模式选择token的生成方式</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;TokenGranter&gt; tokenGranters;</span><br><span class="line">....</span><br><span class="line"><span class="function"><span class="keyword">public</span> OAuth2AccessToken <span class="title">grant</span><span class="params">(String grantType, TokenRequest tokenRequest)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//遍历TokenGranter集合(4种模式+1个Refresh),找到符合的就可以了</span></span><br><span class="line">	<span class="keyword">for</span> (TokenGranter granter : tokenGranters) &#123;</span><br><span class="line">		OAuth2AccessToken grant = granter.grant(grantType, tokenRequest);</span><br><span class="line">		<span class="keyword">if</span> (grant!=<span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> grant;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> OAuth2AccessToken <span class="title">grant</span><span class="params">(String grantType, TokenRequest tokenRequest)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!<span class="keyword">this</span>.grantType.equals(grantType)) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	String clientId = tokenRequest.getClientId();</span><br><span class="line">	ClientDetails client = clientDetailsService.loadClientByClientId(clientId);</span><br><span class="line">	<span class="comment">//校验请求授权码的模式</span></span><br><span class="line">	validateGrantType(grantType, client);</span><br><span class="line">	</span><br><span class="line">	logger.debug(<span class="string">"Getting access token for: "</span> + clientId);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> getAccessToken(client, tokenRequest);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">validateGrantType</span><span class="params">(String grantType, ClientDetails clientDetails)</span> </span>&#123;</span><br><span class="line">	Collection&lt;String&gt; authorizedGrantTypes = clientDetails.getAuthorizedGrantTypes();</span><br><span class="line">	<span class="comment">//如果请求授权码的模式和client_id配置的请求模式不一样,抛异常</span></span><br><span class="line">	<span class="keyword">if</span> (authorizedGrantTypes != <span class="keyword">null</span> &amp;&amp; !authorizedGrantTypes.isEmpty()</span><br><span class="line">			&amp;&amp; !authorizedGrantTypes.contains(grantType)) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> InvalidClientException(<span class="string">"Unauthorized grant type: "</span> + grantType);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p><img src="/images/imageimage-20200320182932444.png" alt="image-20200320182932444"></p>

        <h3   id="封装TokenRequest" >
          <span class="heading-link">封装TokenRequest</span>
        </h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> OAuth2AccessToken <span class="title">getAccessToken</span><span class="params">(ClientDetails client, TokenRequest tokenRequest)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//getOAuth2Authentication根据不同的授权码请求方式,读取相对应的信息</span></span><br><span class="line">	<span class="comment">//例如,授权码模式是先把scope返回去,当带scope来请求token的时候,把之前的用户信息读出来</span></span><br><span class="line">	<span class="comment">//而密码模式就直接读取用户名密码,生成token</span></span><br><span class="line">	<span class="keyword">return</span> tokenServices.createAccessToken(getOAuth2Authentication(client, tokenRequest));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> OAuth2Authentication <span class="title">getOAuth2Authentication</span><span class="params">(ClientDetails client, TokenRequest tokenRequest)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//OAuth2Authentication中封装了TokenRequest</span></span><br><span class="line">	<span class="comment">//先创建TokenRequest:主要是去掉敏感的password和client_secret</span></span><br><span class="line">	<span class="comment">//添加grant_type参数,以便在后续的OAuth2Request中可以获取到</span></span><br><span class="line">	OAuth2Request storedOAuth2Request = requestFactory.createOAuth2Request(client, tokenRequest);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//创建OAuth2Authentication</span></span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> OAuth2Authentication(storedOAuth2Request, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> OAuth2Request <span class="title">createOAuth2Request</span><span class="params">(ClientDetails client)</span> </span>&#123;</span><br><span class="line">	Map&lt;String, String&gt; requestParameters = getRequestParameters();</span><br><span class="line">	HashMap&lt;String, String&gt; modifiable = <span class="keyword">new</span> HashMap&lt;String, String&gt;(requestParameters);</span><br><span class="line">	<span class="comment">// Remove password if present to prevent leaks</span></span><br><span class="line">	modifiable.remove(<span class="string">"password"</span>);</span><br><span class="line">	modifiable.remove(<span class="string">"client_secret"</span>);</span><br><span class="line">	<span class="comment">// Add grant type so it can be retrieved from OAuth2Request</span></span><br><span class="line">	modifiable.put(<span class="string">"grant_type"</span>, grantType);</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> OAuth2Request(modifiable, client.getClientId(), client.getAuthorities(), <span class="keyword">true</span>, <span class="keyword">this</span>.getScope(),</span><br><span class="line">			client.getResourceIds(), <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h3   id="创建AccessToken" >
          <span class="heading-link">创建AccessToken</span>
        </h3>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> OAuth2AccessToken <span class="title">createAccessToken</span><span class="params">(OAuth2Authentication authentication)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//根据token的存储方式,取出之前的token</span></span><br><span class="line">	OAuth2AccessToken existingAccessToken = tokenStore.getAccessToken(authentication);</span><br><span class="line">	OAuth2RefreshToken refreshToken = <span class="keyword">null</span>;</span><br><span class="line">	<span class="keyword">if</span> (existingAccessToken != <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="comment">//如果token过期了,直接移除refreshToken和accessToken</span></span><br><span class="line">		<span class="keyword">if</span> (existingAccessToken.isExpired()) &#123;</span><br><span class="line">			<span class="keyword">if</span> (existingAccessToken.getRefreshToken() != <span class="keyword">null</span>) &#123;</span><br><span class="line">				refreshToken = existingAccessToken.getRefreshToken();</span><br><span class="line">				<span class="comment">// The token store could remove the refresh token when the</span></span><br><span class="line">				<span class="comment">// access token is removed, but we want to</span></span><br><span class="line">				<span class="comment">// be sure...</span></span><br><span class="line">				tokenStore.removeRefreshToken(refreshToken);</span><br><span class="line">			&#125;</span><br><span class="line">			tokenStore.removeAccessToken(existingAccessToken);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">//没过期,可能你又换了中方式来请求token,直接把之前的token重新存储一下</span></span><br><span class="line">			<span class="comment">// Re-store the access token in case the authentication has changed</span></span><br><span class="line">			tokenStore.storeAccessToken(existingAccessToken, authentication);</span><br><span class="line">			<span class="keyword">return</span> existingAccessToken;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Only create a new refresh token if there wasn't an existing one</span></span><br><span class="line">	<span class="comment">// associated with an expired access token.</span></span><br><span class="line">	<span class="comment">// Clients might be holding existing refresh tokens, so we re-use it in</span></span><br><span class="line">	<span class="comment">// the case that the old access token</span></span><br><span class="line">	<span class="comment">// expired.</span></span><br><span class="line">	<span class="keyword">if</span> (refreshToken == <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="comment">//刷新token没有,创建一个</span></span><br><span class="line">		refreshToken = createRefreshToken(authentication);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// But the refresh token itself might need to be re-issued if it has</span></span><br><span class="line">	<span class="comment">// expired.</span></span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (refreshToken <span class="keyword">instanceof</span> ExpiringOAuth2RefreshToken) &#123;</span><br><span class="line">		<span class="comment">//如果刷新token过期了,重新颁发一个</span></span><br><span class="line">		ExpiringOAuth2RefreshToken expiring = (ExpiringOAuth2RefreshToken) refreshToken;</span><br><span class="line">		<span class="keyword">if</span> (System.currentTimeMillis() &gt; expiring.getExpiration().getTime()) &#123;</span><br><span class="line">			refreshToken = createRefreshToken(authentication);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//创建accessToken</span></span><br><span class="line">	OAuth2AccessToken accessToken = createAccessToken(authentication, refreshToken);</span><br><span class="line">	<span class="comment">//存储token</span></span><br><span class="line">	tokenStore.storeAccessToken(accessToken, authentication);</span><br><span class="line">	<span class="comment">// In case it was modified</span></span><br><span class="line">	<span class="comment">//存储刷新token防止修改</span></span><br><span class="line">	refreshToken = accessToken.getRefreshToken();</span><br><span class="line">	<span class="keyword">if</span> (refreshToken != <span class="keyword">null</span>) &#123;</span><br><span class="line">		tokenStore.storeRefreshToken(refreshToken, authentication);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> accessToken;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建accessToken</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> OAuth2AccessToken <span class="title">createAccessToken</span><span class="params">(OAuth2Authentication authentication, OAuth2RefreshToken refreshToken)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//accessToken的创建逻辑就是使用UUID,设置过期时间和刷新token</span></span><br><span class="line">	DefaultOAuth2AccessToken token = <span class="keyword">new</span> DefaultOAuth2AccessToken(UUID.randomUUID().toString());</span><br><span class="line">	<span class="keyword">int</span> validitySeconds = getAccessTokenValiditySeconds(authentication.getOAuth2Request());</span><br><span class="line">	<span class="keyword">if</span> (validitySeconds &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		token.setExpiration(<span class="keyword">new</span> Date(System.currentTimeMillis() + (validitySeconds * <span class="number">1000L</span>)));</span><br><span class="line">	&#125;</span><br><span class="line">	token.setRefreshToken(refreshToken);</span><br><span class="line">	token.setScope(authentication.getOAuth2Request().getScope());</span><br><span class="line">	<span class="comment">//如果配置了token增强,则对token调用增强</span></span><br><span class="line">	<span class="keyword">return</span> accessTokenEnhancer != <span class="keyword">null</span> ? accessTokenEnhancer.enhance(token, authentication) : token;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建refreshToken</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> OAuth2RefreshToken <span class="title">createRefreshToken</span><span class="params">(OAuth2Authentication authentication)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!isSupportRefreshToken(authentication.getOAuth2Request())) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//刷新令牌的创建,直接是UUID,设置过期时间偏移一下</span></span><br><span class="line">	<span class="keyword">int</span> validitySeconds = getRefreshTokenValiditySeconds(authentication.getOAuth2Request());</span><br><span class="line">	String value = UUID.randomUUID().toString();</span><br><span class="line">	<span class="keyword">if</span> (validitySeconds &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> DefaultExpiringOAuth2RefreshToken(value, <span class="keyword">new</span> Date(System.currentTimeMillis()</span><br><span class="line">				+ (validitySeconds * <span class="number">1000L</span>)));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> DefaultOAuth2RefreshToken(value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

</div><footer class="post-footer"><div class="post-end"><p><span>------ </span><span>End of the article, thanks for your reading</span><span> ------</span></p></div><div class="post-copyright"><div class="post-copyright-author"><span class="post-copyright-author-name">Author: </span><span class="post-copyright-author-value"><a href="https://lurongjiang.github.io">LRJ</a></span></div><div class="post-copyright-link"><span class="post-copyright-link-name">Link: </span><span class="post-copyright-link-value"><a href="https://lurongjiang.github.io/2020/02/20/Spring-SpringSecurity%E5%88%9B%E5%BB%BAToken%E7%9A%84%E6%BA%90%E7%A0%81%E8%B7%9F%E8%B8%AA/">https://lurongjiang.github.io/2020/02/20/Spring-SpringSecurity%E5%88%9B%E5%BB%BAToken%E7%9A%84%E6%BA%90%E7%A0%81%E8%B7%9F%E8%B8%AA/</a></span></div><div class="post-copyright-notice"><span class="post-copyright-notice-name">Copyright: </span><span class="post-copyright-notice-value">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" rel="external nofollow" target="_blank">BY-NC-SA</a> unless stating additionally</span></div></div><div class="post-tags"><span class="post-tags-item"><i class="post-tags-item__i fa fa-tags"></i><a class="post-tags-item__a" href="https://lurongjiang.github.io/tags/Spring/">Spring</a></span><span class="post-tags-item"><i class="post-tags-item__i fa fa-tags"></i><a class="post-tags-item__a" href="https://lurongjiang.github.io/tags/SpringSecurity/">SpringSecurity</a></span></div><nav class="paginator"><div class="paginator-post"><div class="paginator-post-prev"><a href="/2020/03/14/%E5%A6%82%E4%BD%95%E9%80%89%E6%8B%A9%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%B9%B3%E5%8F%B0%E8%90%BD%E5%9C%B0%E6%96%B9%E6%A1%88/"><i class="fa fa-chevron-left"></i><span>如何选择大数据平台落地方案</span></a></div><div class="paginator-post-next"><a href="/2020/02/11/Spring-SpringCloud%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/"><span>SpringCloud概述</span><i class="fa fa-chevron-right"></i></a></div></div></nav></footer></div></div></div><aside class="sidebar" id="sidebar"><div class="sidebar-inner"><div class="sidebar-nav"><span class="sidebar-nav-toc current">Catalog</span><span class="sidebar-nav-ov">Overview</span></div><section class="sidebar-toc"><div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#SpringSecurity-创建AccessToken"><span class="toc-number">1.</span> <span class="toc-text">
          SpringSecurity-创建AccessToken
        </span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#创建Token的源码跟踪"><span class="toc-number">1.1.</span> <span class="toc-text">
          创建Token的源码跟踪
        </span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#TokenEndPoint"><span class="toc-number">1.1.1.</span> <span class="toc-text">
          TokenEndPoint
        </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TokenRequest"><span class="toc-number">1.1.2.</span> <span class="toc-text">
          TokenRequest
        </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TokenGranter"><span class="toc-number">1.1.3.</span> <span class="toc-text">
          TokenGranter
        </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#封装TokenRequest"><span class="toc-number">1.1.4.</span> <span class="toc-text">
          封装TokenRequest
        </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建AccessToken"><span class="toc-number">1.1.5.</span> <span class="toc-text">
          创建AccessToken
        </span></a></li></ol></li></ol></li></ol></div></section><!-- ov = overview --><section class="sidebar-ov hide"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="/images/avatar2.png" alt="avatar"></div><p class="sidebar-ov-author__p">LRJ</p></div><div class="sidebar-ov-state"><a class="sidebar-ov-state__a posts" href="/archives/"><div class="sidebar-ov-state__a--count">40</div><div class="sidebar-ov-state__a--name">Archives</div></a><a class="sidebar-ov-state__a categories" href="/categories/"><div class="sidebar-ov-state__a--count">25</div><div class="sidebar-ov-state__a--name">Categories</div></a><a class="sidebar-ov-state__a tags" href="/tags/"><div class="sidebar-ov-state__a--count">32</div><div class="sidebar-ov-state__a--name">Tags</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="Creative Commons" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a></div></section><div class="sidebar-reading"><div class="sidebar-reading-info"><span>You have read </span><span class="sidebar-reading-info-num">0</span></div><div class="sidebar-reading-line"></div></div></div></aside><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright &copy; 2020</span><span class="fa fa-heart footer-icon"></span><span>LRJ.</span></div><div><span>Powered by <a href="http://hexo.io/" title="hexo" target="_blank" rel="noopener">hexo</a></span><span> v4.2.0.</span><span class="separator">|</span><span>Theme - <a href="https://github.com/liuyib/hexo-theme-stun/" title="stun" target="_blank" rel="noopener">stun</a></span><span> v1.7.0.</span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="progress"></div></div><div class="back2top" id="back2top"><i class="back2top-icon fa fa-rocket"></i></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script src="/js/utils.js?v=1.7.0"></script><script src="/js/stun-boot.js?v=1.7.0"></script><script src="/js/scroll.js?v=1.7.0"></script><script src="/js/header.js?v=1.7.0"></script><script src="/js/sidebar.js?v=1.7.0"></script></body></html>